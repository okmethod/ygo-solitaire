var _n=Object.defineProperty;var Cn=(t,e,n)=>e in t?_n(t,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[e]=n;var W=(t,e,n)=>Cn(t,typeof e!="symbol"?e+"":e,n);import{b as Et,d as yt,l as gn,C as ge,a as Ge,e as st,f as ct,g as Me,i as Sn}from"../chunks/BD-KjtcG.js";import{w as Ft,g as ze,d as ie}from"../chunks/C6WtwkGm.js";import{c as be,a as O,f as b}from"../chunks/LOn0ekQa.js";import{k as ne,q as l,y as D,v as d,u as g,x as o,t as ae,j as me,l as _e,ar as Se,m as ee,as as Pt,L as at,V as hn,C as it,o as In}from"../chunks/DKjaHnf_.js";import{s as te,d as Ne,e as Be}from"../chunks/CXYPiKii.js";import{p as Ce,a as On,s as ve}from"../chunks/BFE1hTON.js";import{M as Qe,I as Tt,x as xe,y as Te}from"../chunks/ZKNqOsF7.js";import{i as Y}from"../chunks/CZBA5y4x.js";import{e as Ie,a as En}from"../chunks/CGD6_aVM.js";import{b as Fe,s as pe,j as ot,c as yn}from"../chunks/dG0sfOGW.js";const Lt=["mainMonsterZone","spellTrapZone","fieldZone"],Zt=["mainDeck","extraDeck"],Tn=["hand","graveyard","banished"],Rn=t=>Lt.includes(t),bn=t=>Zt.includes(t),An=t=>t==="hand",xn=t=>t==="graveyard",Dn=t=>t==="banished",Oe={names:[...Lt,...Zt,...Tn],isField:Rn,isDeck:bn,isHand:An,isGraveyard:xn,isBanished:Dn},Nn=t=>t.type==="monster",kn=t=>t.type==="spell",wn=t=>t.type==="spell"&&t.spellType==="normal",Vn=t=>t.type==="spell"&&t.spellType==="quick-play",Mn=t=>t.type==="spell"&&t.spellType==="field",Fn=t=>t.type==="trap",Pn=t=>({position:(t==null?void 0:t.position)??"faceDown",battlePosition:t==null?void 0:t.battlePosition,placedThisTurn:(t==null?void 0:t.placedThisTurn)??!1,counters:[],activatedEffects:new Set}),Ln=t=>Oe.isHand(t.location),Zn=t=>Oe.isField(t.location),Gn=t=>Oe.isGraveyard(t.location),Hn=t=>Oe.isBanished(t.location),Un=t=>{var e;return((e=t.stateOnField)==null?void 0:e.position)==="faceUp"},zn=t=>{var e;return((e=t.stateOnField)==null?void 0:e.position)==="faceDown"},jn=t=>{var e;return((e=t.stateOnField)==null?void 0:e.battlePosition)==="attack"},Bn=t=>{var e;return((e=t.stateOnField)==null?void 0:e.battlePosition)==="defense"},We=(t,e,n)=>({...t,location:e,stateOnField:n}),qn=(t,e)=>We(t,e),Qn=(t,e,n,a)=>{if(!Oe.isField(e))throw new Error(`Invalid location for placing on field: ${e}`);return We(t,e,Pn({position:n,battlePosition:a,placedThisTurn:!0}))},Wn=(t,e)=>{if(Oe.isField(e))throw new Error(`Invalid location for removing from field: ${e}`);return We(t,e,void 0)};function Yn(t,e){if(!Oe.isField(t.location))throw new Error(`Card must be on the field to update state: currently in ${t.location}`);if(!t.stateOnField)throw new Error("Card has no stateOnField to update.");const n={...t.stateOnField,...e};return We(t,t.location,n)}function Kn(t,e){const n=t.find(a=>a.type===e);return(n==null?void 0:n.count)??0}function Xn(t,e,n){const a=t.findIndex(r=>r.type===e);if(a>=0){const r=t[a],s=Math.max(0,r.count+n);return s===0?[...t.slice(0,a),...t.slice(a+1)]:[...t.slice(0,a),{type:e,count:s},...t.slice(a+1)]}else if(n>0)return[...t,{type:e,count:n}];return t}const F={isMonster:Nn,isSpell:kn,isTrap:Fn,isNormalSpell:wn,isQuickPlaySpell:Vn,isFieldSpell:Mn,Instance:{inHand:Ln,onField:Zn,inGraveyard:Gn,isBanished:Hn,isFaceUp:Un,isFaceDown:zn,isAttackPosition:jn,isDefensePosition:Bn,moved:qn,placedOnField:Qn,leavedFromField:Wn,updatedState:Yn},Counter:{get:Kn,update:Xn}};function Jn(t){const e=[...t];for(let n=e.length-1;n>0;n--){const a=Math.floor(Math.random()*(n+1));[e[n],e[a]]=[e[a],e[n]]}return e}const lt=(t,e)=>t[e].length,dt=(t,e)=>{const n=lt(t,"hand");return e.location==="hand"?n-1:n},$n=t=>lt(t,"mainDeck")===0,ut=(t,e,n)=>lt(t,e)>=n,ea=(t,e=5)=>ut(t,"mainMonsterZone",e),ta=(t,e=5)=>ut(t,"spellTrapZone",e),Gt=(t,e=1)=>ut(t,"fieldZone",e);function na(t,e){for(const n of Object.keys(t)){const a=t[n].find(r=>r.instanceId===e);if(a)return a}}function Ye(t,e,n,a){const r=e.location,s=t[r];if(s.findIndex(w=>w.instanceId===e.instanceId)===-1)return t;const u=Oe.isField(n),p=Oe.isField(r),C=u&&!p,E=!u&&p;let I;if(C){if((a==null?void 0:a.position)===void 0)throw new Error("Position must be specified when placing a card on the field.");I=F.Instance.placedOnField(e,n,a==null?void 0:a.position,a==null?void 0:a.battlePosition)}else E?I=F.Instance.leavedFromField(e,n):u&&p&&a!==void 0?I=F.Instance.updatedState(e,a):I=F.Instance.moved(e,n);if(r===n){const w=s.map(V=>V.instanceId===e.instanceId?I:V);return{...t,[r]:w}}const m=s.filter(w=>w.instanceId!==e.instanceId);return{...t,[r]:m,[n]:[...t[n],I]}}function aa(t,e,n){return Ye(t,e,e.location,n)}function ft(t,e=1){const n=t.mainDeck.length;if(n<e)throw new Error(`Cannot draw ${e} cards. Only ${n} cards remaining in main deck.`);let a=t;for(let r=0;r<e;r++){const s=a.mainDeck[a.mainDeck.length-1];a=Ye(a,s,"hand")}return a}function Ht(t){return{...t,mainDeck:Jn(t.mainDeck)}}function ra(t){return Gt(t)?Ye(t,t.fieldZone[0],"graveyard"):t}const Rt=8e3;function ia(t,e){const n=t.mainDeckCardIds.map((c,u)=>({...Et(c),instanceId:`main-${u}`,location:"mainDeck",placedThisTurn:!1,counters:[]})),a=t.extraDeckCardIds.map((c,u)=>({...Et(c),instanceId:`extra-${u}`,location:"extraDeck",placedThisTurn:!1,counters:[]})),r={mainDeck:n,extraDeck:a,hand:[],mainMonsterZone:[],spellTrapZone:[],fieldZone:[],graveyard:[],banished:[]};let s=e!=null&&e.skipShuffle?r:Ht(r);return e!=null&&e.skipInitialDraw||(s=ft(s,5)),{space:s,lp:{player:Rt,opponent:Rt},phase:"draw",turn:1,result:{isGameOver:!1},normalSummonLimit:1,normalSummonUsed:0,activatedCardIds:new Set,queuedEndPhaseEffectIds:[]}}const Ze=["draw","standby","main1","end"],sa={draw:"ドローフェイズ",standby:"スタンバイフェイズ",main1:"メインフェイズ",end:"エンドフェイズ"},ca=t=>sa[t],Ut=t=>{const e=Ze.indexOf(t);return e===-1||e===Ze.length-1?"end":Ze[e+1]},oa=(t,e)=>{const n=Ut(t);return e!==n?{valid:!1,error:`Invalid phase transition: ${t} → ${e}. Expected: ${n}`}:{valid:!0}},Ke=t=>t==="main1",la=t=>t==="end",bt=["exodia","lp0","deckout","surrender"],At=["player","opponent"];function Pe(t=[]){return{isConsistent:t.length===0,errors:t,and(e){return Pe([...this.errors,...e.errors])}}}const he=(t,e,n,a)=>{const r=[];return Number.isInteger(t)||r.push(`${a} must be an integer: ${t}`),(t<e||t>n)&&r.push(`${a} is out of bounds: ${t} (Allowed: ${e} to ${n})`),r},Re=(t,e)=>{const n=t.filter(a=>a.location!==e);return n.length>0?[`${n.length} cards in ${e} have incorrect location property`]:[]};function da(t){const e=[];e.push(...he(t.space.mainDeck.length,0,60,"Deck size")),e.push(...he(t.space.extraDeck.length,0,15,"Extra Deck size")),e.push(...he(t.space.hand.length,0,10,"Hand size")),e.push(...he(t.space.mainMonsterZone.length,0,5,"Main Monster Zone size")),e.push(...he(t.space.spellTrapZone.length,0,5,"Spell/Trap Zone size")),e.push(...he(t.space.fieldZone.length,0,1,"Field Zone size"));const n=[...t.space.mainDeck,...t.space.extraDeck,...t.space.hand,...t.space.mainMonsterZone,...t.space.spellTrapZone,...t.space.fieldZone,...t.space.graveyard,...t.space.banished],a=n.map(c=>c.instanceId),r=a.filter((c,u)=>a.indexOf(c)!==u);r.length>0&&e.push(`Duplicate card instance IDs found: ${r.join(", ")}`);const s=n.filter(c=>!c.instanceId||!c.id);return s.length>0&&e.push(`Found ${s.length} card instances with missing IDs`),e.push(...Re(t.space.mainDeck,"mainDeck")),e.push(...Re(t.space.extraDeck,"extraDeck")),e.push(...Re(t.space.hand,"hand")),e.push(...Re(t.space.mainMonsterZone,"mainMonsterZone")),e.push(...Re(t.space.spellTrapZone,"spellTrapZone")),e.push(...Re(t.space.fieldZone,"fieldZone")),e.push(...Re(t.space.graveyard,"graveyard")),e.push(...Re(t.space.banished,"banished")),Pe(e)}function ua(t){const e=[];return e.push(...he(t.lp.player,0,99999,"Player LP")),e.push(...he(t.lp.opponent,0,99999,"Opponent LP")),Pe(e)}function fa(t){const e=[];return Ze.includes(t.phase)||e.push(`Invalid phase: ${t.phase}. Must be one of: ${Ze.join(", ")}`),Pe(e)}function va(t){const e=[];return e.push(...he(t.turn,1,999,"Turn")),Pe(e)}function pa(t){const e=[];return t.result.isGameOver?(t.result.winner||e.push("Game is over but winner is not set"),t.result.winner&&![...At,"draw"].includes(t.result.winner)&&e.push(`Invalid winner: ${t.result.winner}. Must be one of: ${[...At,"draw"].join(", ")}`),t.result.reason||e.push("Game is over but reason is not set"),t.result.reason&&!bt.includes(t.result.reason)&&e.push(`Invalid reason: ${t.result.reason}. Must be one of: ${bt.join(", ")}`)):(t.result.winner&&e.push("Game is ongoing but winner is set"),t.result.reason&&e.push("Game is ongoing but reason is set")),Pe(e)}function ma(t){return da(t).and(ua(t)).and(fa(t)).and(va(t)).and(pa(t))}function _a(t){const e=ma(t);if(!e.isConsistent)throw new Error(`Invalid GameState:
${e.errors.join(`
`)}`)}const Ca=t=>{const e=[33396948,7902349,70903634,44519536,8124921],n=t.space.hand.map(r=>r.id);return e.every(r=>n.includes(r))},ga=t=>Ca(t)?{isGameOver:!0,winner:"player",reason:"exodia",message:"5つのエクゾディアパーツが手札に揃いました。勝利です！"}:t.lp.player<=0?{isGameOver:!0,winner:"opponent",reason:"lp0",message:"ライフポイントが0になりました。敗北です。"}:t.lp.opponent<=0?{isGameOver:!0,winner:"player",reason:"lp0",message:"相手のライフポイントが0になりました。勝利です！"}:{isGameOver:!1},Sa=t=>{var e;return(e=t.result)!=null&&e.isGameOver?t:{...t,result:ga(t)}},_={initialize:ia,assert:_a,checkVictory:Sa,Phase:{displayName:ca,next:Ut,isMain:Ke,isEnd:la,changeable:oa},Space:{countHandExcludingSelf:dt,isMainDeckEmpty:$n,isMainMonsterZoneFull:ea,isSpellTrapZoneFull:ta,isFieldZoneFull:Gt,findCard:na,moveCard:Ye,updateCardStateInPlace:aa,drawCards:ft,shuffleMainDeck:Ht,sendExistingFieldSpellToGraveyard:ra}};function zt(){return _.initialize({mainDeckCardIds:[],extraDeckCardIds:[]},{skipShuffle:!0,skipInitialDraw:!0})}function xt(t){return t.result.isGameOver,t}function ha(){const{subscribe:t,set:e,update:n}=Ft(zt());return{subscribe:t,set:a=>{e(xt(a))},update:a=>{n(r=>xt(a(r)))}}}const X=ha();function Ia(t){const e=[];t.mainDeck.forEach(a=>{for(let r=0;r<a.quantity;r++)e.push(a.id)});const n=[];return t.extraDeck.forEach(a=>{for(let r=0;r<a.quantity;r++)n.push(a.id)}),{mainDeckCardIds:e,extraDeckCardIds:n}}function Oa(t){const e=Ia(t);X.set(_.initialize(e))}function rt(){let t=zt();return X.subscribe(n=>{t=n})(),t}const Ea={GAME_OVER:"GAME_OVER",NOT_MAIN_PHASE:"NOT_MAIN_PHASE",CARD_NOT_FOUND:"CARD_NOT_FOUND",CARD_NOT_IN_HAND:"CARD_NOT_IN_HAND",CARD_NOT_IN_VALID_LOCATION:"CARD_NOT_IN_VALID_LOCATION",CARD_NOT_ON_FIELD:"CARD_NOT_ON_FIELD",CARD_NOT_FACE_UP:"CARD_NOT_FACE_UP",NOT_SPELL_CARD:"NOT_SPELL_CARD",NOT_SPELL_OR_TRAP_CARD:"NOT_SPELL_OR_TRAP_CARD",NOT_MONSTER_CARD:"NOT_MONSTER_CARD",SPELL_TRAP_ZONE_FULL:"SPELL_TRAP_ZONE_FULL",MONSTER_ZONE_FULL:"MONSTER_ZONE_FULL",INSUFFICIENT_DECK:"INSUFFICIENT_DECK",INSUFFICIENT_COUNTERS:"INSUFFICIENT_COUNTERS",SUMMON_LIMIT_REACHED:"SUMMON_LIMIT_REACHED",QUICK_PLAY_RESTRICTION:"QUICK_PLAY_RESTRICTION",ACTIVATION_CONDITIONS_NOT_MET:"ACTIVATION_CONDITIONS_NOT_MET",NO_IGNITION_EFFECT:"NO_IGNITION_EFFECT",PHASE_TRANSITION_NOT_ALLOWED:"PHASE_TRANSITION_NOT_ALLOWED"},ya={GAME_OVER:"ゲームは終了しています",NOT_MAIN_PHASE:"メインフェイズではありません",CARD_NOT_FOUND:"カードが見つかりません",CARD_NOT_IN_HAND:"カードが手札にありません",CARD_NOT_IN_VALID_LOCATION:"カードが有効な場所にありません",CARD_NOT_ON_FIELD:"カードがフィールドにありません",CARD_NOT_FACE_UP:"カードが表側表示ではありません",NOT_SPELL_CARD:"魔法カードではありません",NOT_SPELL_OR_TRAP_CARD:"魔法または罠カードではありません",NOT_MONSTER_CARD:"モンスターカードではありません",SPELL_TRAP_ZONE_FULL:"魔法・罠ゾーンに空きがありません",MONSTER_ZONE_FULL:"モンスターゾーンに空きがありません",INSUFFICIENT_DECK:"デッキのカードが不足しています",INSUFFICIENT_COUNTERS:"カウンターが不足しています",SUMMON_LIMIT_REACHED:"召喚権がありません",QUICK_PLAY_RESTRICTION:"速攻魔法はセットしたターンに発動できません",ACTIVATION_CONDITIONS_NOT_MET:"発動条件を満たしていません",NO_IGNITION_EFFECT:"このカードには起動効果がありません",PHASE_TRANSITION_NOT_ALLOWED:"フェイズ遷移が許可されていません"},Ta=()=>({isValid:!0}),Ra=(t,e)=>({isValid:!1,errorCode:t,errorParams:e}),ba=t=>{if(t.isValid||!t.errorCode)return"";const e=ya[t.errorCode];return t.errorParams,e},Aa=(t,e,n)=>({success:!0,updatedState:_.checkVictory(t),message:e,emittedEvents:n}),xa=(t,e)=>({success:!1,updatedState:t,error:e});function Da(){return{current:{timestamp:0,events:[]},history:[],nextTimestamp:1}}function jt(t){return{timestamp:t,events:[]}}function Na(t,e){return{...t,current:{...t.current,events:[...t.current.events,e]}}}function ka(t){return t.current.events.length===0?t:{current:jt(t.nextTimestamp),history:[...t.history,t.current],nextTimestamp:t.nextTimestamp+1}}function wa(t){return t.current.events.length>0}function Va(t){return t.current.events}function Ma(t,e){return t.current.events.some(n=>n.type===e)}function Fa(t){return{...t,history:[]}}const i={Validation:{ERROR_CODES:Ea,success:Ta,failure:Ra,errorMessage:ba},Result:{success:Aa,failure:xa},TimeLine:{createEmptyTimeline:Da,createEmptySnapshot:jt,recordEvent:Na,advanceTime:ka,hasCurrentEvents:wa,getCurrentEvents:Va,hasEventOfType:Ma,clearHistory:Fa}};class qe{static register(e,n){const a=this.rules.get(e)||[];this.rules.set(e,[...a,n])}static get(e){return this.rules.get(e)||[]}static getByCategory(e,n){return this.get(e).filter(r=>r.category===n)}static collectActiveRules(e,n){const a=[],r=[...e.space.spellTrapZone,...e.space.fieldZone];for(const s of r){if(!F.Instance.isFaceUp(s))continue;const c=this.getByCategory(s.id,n);for(const u of c)u.canApply(e)&&a.push(u)}return a}static collectTriggerRules(e,n){var s;const a=[],r=[...e.space.mainMonsterZone,...e.space.spellTrapZone,...e.space.fieldZone];for(const c of r){if(!F.Instance.isFaceUp(c))continue;const u=this.getByCategory(c.id,"TriggerRule");for(const p of u)(s=p.triggers)!=null&&s.includes(n)&&a.push({rule:p,sourceInstance:c})}return a}static collectTriggerSteps(e,n){const a=this.collectTriggerRules(e,n),r=[];for(const{rule:s,sourceInstance:c}of a)if(s.canApply(e)&&s.createTriggerSteps){const u=s.createTriggerSteps(e,c);r.push(...u)}return r}static clear(){this.rules.clear()}static getRegisteredCardIds(){return Array.from(this.rules.keys())}}W(qe,"rules",new Map);function Xe(t,e,n){const a=t.action(e,n);return a.success?(X.set(a.updatedState),{updatedState:a.updatedState,emittedEvents:a.emittedEvents||[]}):{updatedState:e,emittedEvents:[]}}function Pa(t,e,n,a){const r=[];for(const s of t){const c=qe.collectTriggerSteps(e,s.type);r.push(...c)}return r.length===0?n:[...n.slice(0,a+1),...r,...n.slice(a+1)]}function La(t,e){const n=t.currentIndex+1;return n<t.steps.length?(e(a=>({...a,currentIndex:n,currentStep:a.steps[n]})),!0):(Bt(e),!1)}function Bt(t){t(e=>({...e,isActive:!1,currentStep:null,steps:[],currentIndex:-1}))}const Za=async(t,e)=>({shouldContinue:!0,emittedEvents:Xe(t,e).emittedEvents}),Ga=async(t,e,n)=>{const a=Xe(t,e);return n.notification&&n.notification.showInfo(t.summary,t.description),{shouldContinue:!0,delay:300,emittedEvents:a.emittedEvents}},Ha=async(t,e,n,a)=>{const r=t.cardSelectionConfig;let s;if(r.availableCards!==null)s=r.availableCards;else{if(!r._sourceZone)return console.error("_sourceZone must be specified when availableCards is null"),{shouldContinue:!1};const u=e.space[r._sourceZone];s=r._filter?u.filter((p,C)=>r._filter(p,C)):u}let c=[];return await new Promise(u=>{a(p=>({...p,cardSelectionConfig:{availableCards:s,minCards:r.minCards,maxCards:r.maxCards,summary:r.summary,description:r.description,cancelable:r.cancelable,onConfirm:C=>{c=Xe(t,e,C).emittedEvents,a(I=>({...I,cardSelectionConfig:null})),u()},onCancel:()=>{a(C=>({...C,cardSelectionConfig:null})),u()}}}))}),{shouldContinue:!0,emittedEvents:c}},Ua=async(t,e,n,a)=>{let r=[];return await new Promise(s=>{a(c=>({...c,confirmationConfig:{summary:t.summary,description:t.description,onConfirm:()=>{r=Xe(t,e).emittedEvents,a(p=>({...p,confirmationConfig:null})),s()}}}))}),{shouldContinue:!0,emittedEvents:r}};function za(t){const e=t.notificationLevel||"info";return e==="silent"?Za:e==="info"?Ga:t.cardSelectionConfig?Ha:Ua}function ja(){const{subscribe:t,update:e}=Ft({isActive:!1,currentStep:null,steps:[],currentIndex:-1,notificationHandler:null,confirmationConfig:null,cardSelectionConfig:null,eventTimeline:i.TimeLine.createEmptyTimeline()});return{subscribe:t,registerNotificationHandler:n=>{e(a=>({...a,notificationHandler:n}))},startProcessing:n=>{e(r=>({...r,isActive:!0,steps:n,currentIndex:0,currentStep:n[0]||null}));const a=n[0];if(a){const r=a.notificationLevel||"info";(r==="info"||r==="silent")&&De.confirmCurrentStep()}},confirmCurrentStep:async()=>{let n=ze(De);if(!n.currentStep)return;const a=ze(X),s=await za(n.currentStep)(n.currentStep,a,{notification:n.notificationHandler},e);if(s.emittedEvents&&s.emittedEvents.length>0){let c=n.eventTimeline;for(const C of s.emittedEvents)c=i.TimeLine.recordEvent(c,C);const u=ze(X),p=Pa(s.emittedEvents,u,n.steps,n.currentIndex);e(C=>({...C,steps:p,eventTimeline:c})),n=ze(De)}s.delay&&await new Promise(c=>setTimeout(c,s.delay)),s.shouldContinue?La(n,e)&&De.confirmCurrentStep():Bt(e)},cancelProcessing:()=>{e(n=>({...n,isActive:!1,currentStep:null,steps:[],currentIndex:-1}))},reset:()=>{e(n=>({...n,isActive:!1,currentStep:null,steps:[],currentIndex:-1}))}}}const De=ja(),Ba=(t,e,n,a)=>({success:!0,updatedState:_.checkVictory(t),message:e,emittedEvents:n,effectSteps:a??[]}),qa=(t,e)=>({success:!1,updatedState:t,error:e,effectSteps:[]}),oe={Result:{success:Ba,failure:qa}};class Qa{constructor(){W(this,"description");this.description="Advance to next phase"}canExecute(e){if(e.result.isGameOver)return i.Validation.failure(i.Validation.ERROR_CODES.GAME_OVER);const n=_.Phase.next(e.phase);return _.Phase.changeable(e.phase,n).valid?i.Validation.success():i.Validation.failure(i.Validation.ERROR_CODES.PHASE_TRANSITION_NOT_ALLOWED)}execute(e){const n=this.canExecute(e);if(!n.isValid)return oe.Result.failure(e,i.Validation.errorMessage(n));const a=_.Phase.next(e.phase),r=_.Phase.isEnd(a)&&e.queuedEndPhaseEffectIds.length>0,s=_.Phase.isEnd(a)?this.resetFieldCardActivatedEffects(e.space):e.space,c={...e,space:s,phase:a,activatedCardIds:_.Phase.isEnd(a)?new Set:e.activatedCardIds,queuedEndPhaseEffectIds:r?[]:e.queuedEndPhaseEffectIds};return oe.Result.success(c,`Advanced to ${_.Phase.displayName(a)}`)}getNextPhase(e){return _.Phase.next(e.phase)}resetFieldCardActivatedEffects(e){const n=a=>{if(!a.stateOnField||a.stateOnField.activatedEffects.size===0)return a;const r={...a.stateOnField,activatedEffects:new Set};return{...a,stateOnField:r}};return{...e,mainMonsterZone:e.mainMonsterZone.map(n),spellTrapZone:e.spellTrapZone.map(n),fieldZone:e.fieldZone.map(n)}}}function qt(t){return _.Phase.isMain(t.phase)?_.Space.isMainMonsterZoneFull(t.space)?i.Validation.failure(i.Validation.ERROR_CODES.MONSTER_ZONE_FULL):t.normalSummonUsed>=t.normalSummonLimit?i.Validation.failure(i.Validation.ERROR_CODES.SUMMON_LIMIT_REACHED):i.Validation.success():i.Validation.failure(i.Validation.ERROR_CODES.NOT_MAIN_PHASE)}function Qt(t,e,n){const a=_.Space.findCard(t.space,e),r=_.Space.moveCard(t.space,a,"mainMonsterZone",{position:n==="attack"?"faceUp":"faceDown",battlePosition:n});return{...t,space:r,normalSummonUsed:t.normalSummonUsed+1}}class Dt{constructor(e){W(this,"description");this.cardInstanceId=e,this.description=`Summon monster ${e}`}canExecute(e){if(e.result.isGameOver)return i.Validation.failure(i.Validation.ERROR_CODES.GAME_OVER);const n=qt(e);if(!n.isValid)return n;const a=_.Space.findCard(e.space,this.cardInstanceId);return a?F.isMonster(a)?F.Instance.inHand(a)?i.Validation.success():i.Validation.failure(i.Validation.ERROR_CODES.CARD_NOT_IN_HAND):i.Validation.failure(i.Validation.ERROR_CODES.NOT_MONSTER_CARD):i.Validation.failure(i.Validation.ERROR_CODES.CARD_NOT_FOUND)}execute(e){const n=this.canExecute(e);if(!n.isValid)return oe.Result.failure(e,i.Validation.errorMessage(n));const a=_.Space.findCard(e.space,this.cardInstanceId),r=Qt(e,this.cardInstanceId,"attack");return oe.Result.success(r,`Monster summoned: ${a.jaName}`)}getCardInstanceId(){return this.cardInstanceId}}class Nt{constructor(e){W(this,"description");this.cardInstanceId=e,this.description=`Set monster ${e}`}canExecute(e){if(e.result.isGameOver)return i.Validation.failure(i.Validation.ERROR_CODES.GAME_OVER);const n=qt(e);if(!n.isValid)return n;const a=_.Space.findCard(e.space,this.cardInstanceId);return a?F.isMonster(a)?F.Instance.inHand(a)?i.Validation.success():i.Validation.failure(i.Validation.ERROR_CODES.CARD_NOT_IN_HAND):i.Validation.failure(i.Validation.ERROR_CODES.NOT_MONSTER_CARD):i.Validation.failure(i.Validation.ERROR_CODES.CARD_NOT_FOUND)}execute(e){const n=this.canExecute(e);if(!n.isValid)return oe.Result.failure(e,i.Validation.errorMessage(n));const a=_.Space.findCard(e.space,this.cardInstanceId),r=Qt(e,this.cardInstanceId,"defense");return oe.Result.success(r,`Monster set: ${a.jaName}`)}getCardInstanceId(){return this.cardInstanceId}}class kt{constructor(e){W(this,"description");this.cardInstanceId=e,this.description=`Set spell/trap ${e}`}canExecute(e){if(e.result.isGameOver)return i.Validation.failure(i.Validation.ERROR_CODES.GAME_OVER);if(!_.Phase.isMain(e.phase))return i.Validation.failure(i.Validation.ERROR_CODES.NOT_MAIN_PHASE);const n=_.Space.findCard(e.space,this.cardInstanceId);return n?!F.isSpell(n)&&!F.isTrap(n)?i.Validation.failure(i.Validation.ERROR_CODES.NOT_SPELL_OR_TRAP_CARD):F.Instance.inHand(n)?!F.isFieldSpell(n)&&_.Space.isSpellTrapZoneFull(e.space)?i.Validation.failure(i.Validation.ERROR_CODES.SPELL_TRAP_ZONE_FULL):i.Validation.success():i.Validation.failure(i.Validation.ERROR_CODES.CARD_NOT_IN_HAND):i.Validation.failure(i.Validation.ERROR_CODES.CARD_NOT_FOUND)}execute(e){const n=this.canExecute(e);if(!n.isValid)return oe.Result.failure(e,i.Validation.errorMessage(n));const a=_.Space.findCard(e.space,this.cardInstanceId),r={...e,space:this.moveSetSpellTrapCard(e.space,a)};return oe.Result.success(r,`Card set: ${a.jaName}`)}moveSetSpellTrapCard(e,n){if(F.isFieldSpell(n)){const a=_.Space.sendExistingFieldSpellToGraveyard(e);return _.Space.moveCard(a,n,"fieldZone",{position:"faceDown"})}return _.Space.moveCard(e,n,"spellTrapZone",{position:"faceDown"})}getCardInstanceId(){return this.cardInstanceId}}class K{static registerActivation(e,n){const a=this.getOrCreateEntry(e);a.activation=n}static registerIgnition(e,n){this.getOrCreateEntry(e).ignitionEffects.push(n)}static getActivation(e){var n;return(n=this.effects.get(e))==null?void 0:n.activation}static getIgnitionEffects(e){var n;return((n=this.effects.get(e))==null?void 0:n.ignitionEffects)??[]}static hasIgnitionEffects(e){const n=this.effects.get(e);return n!==void 0&&n.ignitionEffects.length>0}static clear(){this.effects.clear()}static getRegisteredCardIds(){return Array.from(this.effects.keys())}static getOrCreateEntry(e){let n=this.effects.get(e);return n||(n={ignitionEffects:[]},this.effects.set(e,n)),n}}W(K,"effects",new Map);class wt{constructor(e){W(this,"description");this.cardInstanceId=e,this.description=`Activate spell card ${e}`}canExecute(e){if(e.result.isGameOver)return i.Validation.failure(i.Validation.ERROR_CODES.GAME_OVER);const n=_.Space.findCard(e.space,this.cardInstanceId);if(!n)return i.Validation.failure(i.Validation.ERROR_CODES.CARD_NOT_FOUND);if(!F.isSpell(n))return i.Validation.failure(i.Validation.ERROR_CODES.NOT_SPELL_CARD);if(!F.Instance.inHand(n)&&!(F.Instance.onField(n)&&F.Instance.isFaceDown(n)))return i.Validation.failure(i.Validation.ERROR_CODES.CARD_NOT_IN_VALID_LOCATION);if(!F.isFieldSpell(n)&&_.Space.isSpellTrapZoneFull(e.space))return i.Validation.failure(i.Validation.ERROR_CODES.SPELL_TRAP_ZONE_FULL);const a=K.getActivation(n.id);if(a){const r=a.canActivate(e,n);if(!r.isValid)return r}return i.Validation.success()}execute(e){const n=this.canExecute(e);if(!n.isValid)return oe.Result.failure(e,i.Validation.errorMessage(n));const a=_.Space.findCard(e.space,this.cardInstanceId),r=new Set(e.activatedCardIds);r.add(a.id);const s={...e,space:this.moveActivatedSpellCard(e.space,a),activatedCardIds:r};return oe.Result.success(s,`Spell card activated: ${this.cardInstanceId}`,[],this.buildEffectSteps(s,a))}moveActivatedSpellCard(e,n){if(n.location==="hand"){if(F.isFieldSpell(n)){const a=_.Space.sendExistingFieldSpellToGraveyard(e);return _.Space.moveCard(a,n,"fieldZone",{position:"faceUp"})}return _.Space.moveCard(e,n,"spellTrapZone",{position:"faceUp"})}return _.Space.updateCardStateInPlace(e,n,{position:"faceUp"})}buildEffectSteps(e,n){const a=[],r=K.getActivation(n.id);return r&&(a.push(...r.createActivationSteps(e,n)),a.push(...r.createResolutionSteps(e,n))),a}getCardInstanceId(){return this.cardInstanceId}}class Vt{constructor(e){W(this,"description");this.cardInstanceId=e,this.description=`Activate ignition effect of ${e}`}canExecute(e){if(e.result.isGameOver)return i.Validation.failure(i.Validation.ERROR_CODES.GAME_OVER);const n=_.Space.findCard(e.space,this.cardInstanceId);if(!n)return i.Validation.failure(i.Validation.ERROR_CODES.CARD_NOT_FOUND);if(!["fieldZone","spellTrapZone","mainMonsterZone"].includes(n.location))return i.Validation.failure(i.Validation.ERROR_CODES.CARD_NOT_ON_FIELD);if(!F.Instance.isFaceUp(n))return i.Validation.failure(i.Validation.ERROR_CODES.CARD_NOT_FACE_UP);const r=K.getIgnitionEffects(n.id);return r.length===0?i.Validation.failure(i.Validation.ERROR_CODES.NO_IGNITION_EFFECT):this.findActivatableEffect(r,e,n)?i.Validation.success():i.Validation.failure(i.Validation.ERROR_CODES.ACTIVATION_CONDITIONS_NOT_MET)}findActivatableEffect(e,n,a){return e.find(r=>r.canActivate(n,a).isValid)}execute(e){const n=this.canExecute(e);if(!n.isValid)return oe.Result.failure(e,i.Validation.errorMessage(n));const a=_.Space.findCard(e.space,this.cardInstanceId),r=K.getIgnitionEffects(a.id),s=this.findActivatableEffect(r,e,a),c=a.stateOnField,u=new Set(c.activatedEffects);u.add(s.effectId);const p={...e,space:_.Space.updateCardStateInPlace(e.space,a,{activatedEffects:u})};return oe.Result.success(p,`Ignition effect activated: ${this.cardInstanceId}`,[],this.buildEffectSteps(p,a,s))}buildEffectSteps(e,n,a){const r=a.createActivationSteps(e,n),s=a.createResolutionSteps(e,n);return[...r,...s]}getCardInstanceId(){return this.cardInstanceId}}const Wt=t=>({id:`${t}-activation-notification`,summary:"カード発動",description:`${yt(t)}を発動します`,notificationLevel:"info",action:e=>({success:!0,updatedState:e,message:`${yt(t)} activated`})}),Yt=t=>({id:t.id,summary:t.summary,description:t.description,notificationLevel:"interactive",cardSelectionConfig:{availableCards:t.availableCards,_sourceZone:t._sourceZone,_filter:t._filter,minCards:t.minCards,maxCards:t.maxCards,summary:t.summary,description:t.description,cancelable:t.cancelable??!1},action:(e,n)=>!n||n.length===0?t.onSelect(e,[]):t.onSelect(e,n)});function Wa(t){return{id:`emit-spell-activated-${t.instanceId}`,summary:"魔法発動イベント",description:"魔法カード発動をトリガーシステムに通知",notificationLevel:"silent",action:e=>i.Result.success(e,void 0,[{type:"spellActivated",sourceCardId:t.id,sourceInstanceId:t.instanceId}])}}class Je{constructor(e){W(this,"cardId");W(this,"effectId");W(this,"effectCategory","activation");this.cardId=e,this.effectId=`activation-${e}`}canActivate(e,n){const a=this.subTypeConditions(e,n);if(!a.isValid)return a;const r=this.individualConditions(e,n);return r.isValid?i.Validation.success():r}createActivationSteps(e,n){return[Wt(this.cardId),Wa(n),...this.subTypePreActivationSteps(e,n),...this.individualActivationSteps(e,n),...this.subTypePostActivationSteps(e,n)]}createResolutionSteps(e,n){return[...this.subTypePreResolutionSteps(e,n),...this.individualResolutionSteps(e,n),...this.subTypePostResolutionSteps(e,n)]}}function Ya(t,e){return{id:(e==null?void 0:e.id)??`queue-end-phase-effect-${t.id}`,summary:(e==null?void 0:e.summary)??"エンドフェイズ効果を登録",description:(e==null?void 0:e.description)??"エンドフェイズに処理される効果を登録します",notificationLevel:"silent",action:n=>({success:!0,updatedState:{...n,queuedEndPhaseEffectIds:[...n.queuedEndPhaseEffectIds,t.id]},message:`Added end phase effect: ${t.summary}`})}}const Kt=(t,e)=>({id:`send-${t}-to-graveyard`,summary:"墓地へ送る",description:`《${e}》を墓地に送ります`,notificationLevel:"info",action:n=>{const a=_.Space.findCard(n.space,t);return{success:!0,updatedState:{...n,space:_.Space.moveCard(n.space,a,"graveyard")},message:`Sent ${e} to graveyard`}}}),Xt=(t,e)=>{let n=t.space;for(const a of e){const r=_.Space.findCard(n,a);n=_.Space.moveCard(n,r,"graveyard")}return{success:!0,updatedState:{...t,space:n},message:`Sent ${e.length} card${e.length>1?"s":""} to graveyard`}},Ka=t=>{const e=[...t.space.hand];if(e.length===0)return{success:!0,updatedState:t,message:"No cards in hand to discard"};const n=e.map(a=>a.instanceId);return Xt(t,n)},Xa=()=>({id:"discard-all-hand",summary:"手札を全て捨てる",description:"手札を全て捨てます",notificationLevel:"info",action:t=>Ka(t)}),Jt=()=>Ya(Xa(),{id:"end-phase-discard-all-hand",summary:"手札を全て捨てる",description:"エンドフェイズに手札を全て捨てます"}),vt=(t,e)=>Yt({id:`select-and-discard-${t}-cards`,summary:`手札を${t}枚捨てる`,description:`手札から${t}枚選んで捨てます`,availableCards:null,_sourceZone:"hand",_filter:void 0,minCards:t,maxCards:t,cancelable:!1,onSelect:(n,a)=>a.length!==t?{success:!1,updatedState:n,error:`Must select exactly ${t} cards to discard`}:Xt(n,a)});class le extends Je{constructor(){super(...arguments);W(this,"spellSpeed",1)}subTypeConditions(n,a){return Ke(n.phase)?i.Validation.success():i.Validation.failure(i.Validation.ERROR_CODES.NOT_MAIN_PHASE)}subTypePreActivationSteps(n,a){return[]}subTypePostActivationSteps(n){return[]}subTypePreResolutionSteps(n,a){return[]}subTypePostResolutionSteps(n,a){return[Kt(a.instanceId,a.jaName)]}}const $t=(t,e)=>({id:e.id,summary:e.summary,description:e.description,notificationLevel:"info",action:n=>{const{drawCount:a,message:r}=t(n);return a===0?{success:!0,updatedState:n,message:r}:n.space.mainDeck.length<a?{success:!1,updatedState:n,error:`Insufficient deck: needed ${a}, but only ${n.space.mainDeck.length} remaining.`}:{success:!0,updatedState:{...n,space:ft(n.space,a)},message:`${r} (${a} card${a>1?"s":""})`}}}),Ae=t=>$t(()=>({drawCount:t,message:`Draw ${t} card(s)`}),{id:`draw-${t}`,summary:"カードをドロー",description:`デッキから${t}枚ドローします`}),Ja=t=>$t(e=>{const n=Math.max(0,t-e.space.hand.length);return{drawCount:n,message:n===0?`Hand already has ${t} or more cards`:`Filled hand to ${t}`}},{id:`fill-hands-${t}`,summary:`手札が${t}枚になるまでドロー`,description:`手札が${t}枚になるまでドローします`});class $a extends le{constructor(){super(55144522)}individualConditions(e,n){return e.space.mainDeck.length<2?i.Validation.failure(i.Validation.ERROR_CODES.ACTIVATION_CONDITIONS_NOT_MET):i.Validation.success()}individualActivationSteps(e,n){return[]}individualResolutionSteps(e,n){return[Ae(2)]}}class er extends le{constructor(){super(79571449)}individualConditions(e,n){return e.space.mainDeck.length<3?i.Validation.failure(i.Validation.ERROR_CODES.ACTIVATION_CONDITIONS_NOT_MET):i.Validation.success()}individualActivationSteps(e,n){return[]}individualResolutionSteps(e,n){return[Ae(3),vt(2)]}}class tr extends Je{constructor(){super(...arguments);W(this,"spellSpeed",1)}subTypeConditions(n,a){return Ke(n.phase)?i.Validation.success():i.Validation.failure(i.Validation.ERROR_CODES.NOT_MAIN_PHASE)}subTypePreActivationSteps(n,a){return[]}subTypePostActivationSteps(n,a){return[]}subTypePreResolutionSteps(n,a){return[]}subTypePostResolutionSteps(n,a){return[]}}class nr extends tr{constructor(){super(67616300)}individualConditions(e,n){return i.Validation.success()}individualActivationSteps(e,n){return[]}individualResolutionSteps(e,n){return[]}}const en=(t,e,n)=>{const a=n==="player",r=a?"プレイヤー":"相手",s=a?"Player":"Opponent",c=t==="gain"?1:-1,u={gain:{id:"gain-lp",action:"増加",msg:"gained"},damage:{id:"damage",action:"ダメージ",msg:"took"},payment:{id:"pay-lp",action:"支払い",msg:"paid"},loss:{id:"loss-lp",action:"喪失",msg:"lost"}}[t];return{id:`${u.id}-${n}-${e}`,summary:`${r}のLP${u.action}`,description:`${r}に${e}の${u.action}が発生します`,notificationLevel:"info",action:p=>({success:!0,updatedState:{...p,lp:{...p.lp,[n]:p.lp[n]+e*c}},message:`${s} ${u.msg} ${e} LP`})}},ar=(t,e)=>en("gain",t,e),tn=(t,e)=>en("payment",t,e);class rr extends le{constructor(){super(70368879)}individualConditions(e,n){return e.space.mainDeck.length<1?i.Validation.failure(i.Validation.ERROR_CODES.ACTIVATION_CONDITIONS_NOT_MET):i.Validation.success()}individualActivationSteps(e,n){return[]}individualResolutionSteps(e,n){return[Ae(1),ar(1e3,"opponent")]}}class ir extends le{constructor(){super(33782437)}individualConditions(e,n){return e.space.mainDeck.length<1?i.Validation.failure(i.Validation.ERROR_CODES.ACTIVATION_CONDITIONS_NOT_MET):i.Validation.success()}individualActivationSteps(e,n){return[]}individualResolutionSteps(e,n){return[Ae(1),{id:"one-day-of-peace-damage-negation",summary:"ダメージ無効化",description:"このターン、全てのダメージは0になります",notificationLevel:"info",action:a=>({success:!0,updatedState:{...a,damageNegation:!0},message:"Damage negation activated for this turn"})}]}}const sr=t=>Yt({id:"select-and-return-to-deck",summary:"手札をデッキに戻す",description:`デッキに戻すカードを選択してください（${t.min}〜${t.max??100}枚）`,availableCards:null,_sourceZone:"hand",_filter:void 0,minCards:t.min,maxCards:t.max??100,cancelable:!1,onSelect:(e,n)=>{if(n.length===0)return{success:!0,updatedState:e,message:"No cards selected"};let a=e.space;for(const r of n){const s=_.Space.findCard(a,r);a=_.Space.moveCard(a,s,"mainDeck")}return a=_.Space.shuffleMainDeck(a),a=_.Space.drawCards(a,n.length),{success:!0,updatedState:{...e,space:a},message:`${n.length}枚をデッキに戻し、シャッフルして${n.length}枚ドローしました`}}});class cr extends le{constructor(){super(85852291)}individualConditions(e,n){return i.Validation.success()}individualActivationSteps(e,n){return[]}individualResolutionSteps(e,n){return[sr({min:0})]}}class or extends Je{constructor(){super(...arguments);W(this,"spellSpeed",2)}subTypeConditions(n,a){var r;return F.Instance.isFaceDown(a)&&((r=a.stateOnField)!=null&&r.placedThisTurn)?i.Validation.failure(i.Validation.ERROR_CODES.QUICK_PLAY_RESTRICTION):i.Validation.success()}subTypePreActivationSteps(n,a){return[]}subTypePostActivationSteps(n,a){return[]}subTypePreResolutionSteps(n,a){return[]}subTypePostResolutionSteps(n,a){return[Kt(a.instanceId,a.jaName)]}}class lr extends or{constructor(){super(74519184)}individualConditions(e,n){return dt(e.space,n)<2||e.space.mainDeck.length<2?i.Validation.failure(i.Validation.ERROR_CODES.ACTIVATION_CONDITIONS_NOT_MET):i.Validation.success()}individualActivationSteps(e,n){return[]}individualResolutionSteps(e,n){return[vt(2),Ae(2)]}}const nn=(t,e,n)=>({id:t.id,summary:t.summary,description:t.description,notificationLevel:"interactive",cardSelectionConfig:{availableCards:null,minCards:t.minCards,maxCards:t.maxCards,summary:t.summary,description:t.description,cancelable:t.cancelable??!1,_sourceZone:e,_filter:t.filter},action:(a,r)=>{if((e==="graveyard"?a.space.graveyard.filter(t.filter):a.space.mainDeck.filter((C,E)=>t.filter(C,E))).length===0)return{success:!1,updatedState:a,error:`No cards available in ${e} matching the criteria`};if(!r||r.length===0)return{success:!1,updatedState:a,error:"No cards selected"};let c=a.space;for(const C of r){const E=_.Space.findCard(c,C);c=_.Space.moveCard(c,E,"hand")}n&&(c=_.Space.shuffleMainDeck(c));const u={...a,space:c},p=n?" and shuffled":"";return{success:!0,updatedState:u,message:`Added ${r.length} card${r.length>1?"s":""} from ${e} to hand${p}`}}}),an=t=>nn(t,"graveyard",!1),rn=t=>nn(t,"mainDeck",!0),dr=t=>({id:t.id,summary:t.summary,description:t.description,notificationLevel:"interactive",cardSelectionConfig:{availableCards:null,minCards:t.minCards,maxCards:t.maxCards,summary:t.summary,description:t.description,cancelable:t.cancelable??!1,_sourceZone:"mainDeck",_filter:(e,n)=>n!==void 0&&n<t.count},action:(e,n)=>{const a=e.space.mainDeck.slice(0,t.count);if(a.length<t.count)return{success:!1,updatedState:e,error:`Cannot excavate ${t.count} cards. Deck has only ${a.length} cards.`};if(!n||n.length===0)return{success:!1,updatedState:e,error:"No cards selected"};let r=e.space;for(const c of n){const u=_.Space.findCard(r,c);r=_.Space.moveCard(r,u,"hand")}return{success:!0,updatedState:{...e,space:r},message:`Added ${n.length} card${n.length>1?"s":""} from deck to hand`}}});class ur extends le{constructor(){super(90928333)}individualConditions(e,n){return e.space.graveyard.filter(r=>r.type==="monster"&&r.frameType==="normal").length<2?i.Validation.failure(i.Validation.ERROR_CODES.ACTIVATION_CONDITIONS_NOT_MET):i.Validation.success()}individualActivationSteps(e,n){return[]}individualResolutionSteps(e,n){return[an({id:`dark-factory-search-${n.instanceId}`,summary:"通常モンスター2枚をサルベージ",description:"墓地から通常モンスター2枚を選択し、手札に加えます",filter:a=>a.type==="monster"&&a.frameType==="normal",minCards:2,maxCards:2,cancelable:!1})]}}class fr extends le{constructor(){super(73628505)}individualConditions(e,n){return e.space.mainDeck.filter(r=>r.type==="spell"&&r.spellType==="field").length<1?i.Validation.failure(i.Validation.ERROR_CODES.ACTIVATION_CONDITIONS_NOT_MET):i.Validation.success()}individualActivationSteps(e,n){return[]}individualResolutionSteps(e,n){return[rn({id:`terraforming-search-${n.instanceId}`,summary:"フィールド魔法1枚をサーチ",description:"デッキからフィールド魔法1枚を選択し、手札に加えます",filter:a=>a.type==="spell"&&a.spellType==="field",minCards:1,maxCards:1,cancelable:!1})]}}class vr extends le{constructor(){super(98494543)}individualConditions(e,n){return dt(e.space,n)<2||e.space.graveyard.filter(r=>r.type==="spell").length<1?i.Validation.failure(i.Validation.ERROR_CODES.ACTIVATION_CONDITIONS_NOT_MET):i.Validation.success()}individualActivationSteps(e,n){return[vt(2)]}individualResolutionSteps(e,n){return[an({id:`magical-stone-excavation-search-${n.instanceId}`,summary:"魔法カード1枚をサルベージ",description:"墓地から魔法カード1枚を選択し、手札に加えます",filter:a=>a.type==="spell",minCards:1,maxCards:1,cancelable:!1})]}}class pr extends le{constructor(){super(93946239)}individualConditions(e,n){return e.space.hand.length<3||e.space.mainDeck.length<1?i.Validation.failure(i.Validation.ERROR_CODES.ACTIVATION_CONDITIONS_NOT_MET):i.Validation.success()}individualActivationSteps(e,n){return[]}individualResolutionSteps(e,n){return[Ae(1),Jt()]}}const mr=()=>({id:"shuffle-deck",summary:"デッキシャッフル",description:"デッキをシャッフルします",notificationLevel:"info",action:t=>({success:!0,updatedState:{...t,space:_.Space.shuffleMainDeck(t.space)},message:"Deck shuffled"})});class _r extends le{constructor(){super(98645731)}individualConditions(e,n){return e.activatedCardIds.has(this.cardId)||e.space.mainDeck.length<3?i.Validation.failure(i.Validation.ERROR_CODES.ACTIVATION_CONDITIONS_NOT_MET):i.Validation.success()}individualActivationSteps(e,n){return[]}individualResolutionSteps(e,n){return[dr({id:`pot-of-duality-search-${n.instanceId}`,summary:"デッキトップ3枚から1枚をサーチ",description:"デッキトップ3枚から1枚を選択し、手札に加えます",count:3,minCards:1,maxCards:1,cancelable:!1}),mr()]}}class Cr extends le{constructor(){super(59750328)}individualConditions(e,n){return e.activatedCardIds.has(this.cardId)?i.Validation.failure(i.Validation.ERROR_CODES.ACTIVATION_CONDITIONS_NOT_MET):i.Validation.success()}individualActivationSteps(e,n){return[]}individualResolutionSteps(e,n){return[Ja(3),Jt()]}}class gr extends le{constructor(){super(89997728)}individualConditions(e,n){return e.space.mainDeck.filter(r=>r.jaName.includes("トゥーン")).length<1?i.Validation.failure(i.Validation.ERROR_CODES.ACTIVATION_CONDITIONS_NOT_MET):i.Validation.success()}individualActivationSteps(e,n){return[]}individualResolutionSteps(e,n){return[rn({id:`toon-table-search-${n.instanceId}`,summary:"「トゥーン」カード1枚をサーチ",description:"デッキから「トゥーン」カード1枚を選択し、手札に加えます",filter:a=>a.jaName.includes("トゥーン"),minCards:1,maxCards:1,cancelable:!1})]}}class Sr extends Je{constructor(){super(...arguments);W(this,"spellSpeed",1)}subTypeConditions(n,a){return _.Phase.isMain(n.phase)?i.Validation.success():i.Validation.failure(i.Validation.ERROR_CODES.NOT_MAIN_PHASE)}subTypePreActivationSteps(n,a){return[]}subTypePostActivationSteps(n,a){return[]}subTypePreResolutionSteps(n,a){return[]}subTypePostResolutionSteps(n,a){return[]}}class hr extends Sr{constructor(){super(15259703)}individualConditions(e,n){return e.lp.player<1e3?i.Validation.failure(i.Validation.ERROR_CODES.ACTIVATION_CONDITIONS_NOT_MET):i.Validation.success()}individualActivationSteps(e,n){return[tn(1e3,"player")]}individualResolutionSteps(e,n){return[]}}class sn{constructor(e,n){W(this,"cardId");W(this,"effectId");W(this,"effectCategory","ignition");W(this,"spellSpeed",1);this.cardId=e,this.effectId=`ignition-${e}-${n}`}canActivate(e,n){if(!Ke(e.phase))return i.Validation.failure(i.Validation.ERROR_CODES.NOT_MAIN_PHASE);const a=this.individualConditions(e,n);return a.isValid?i.Validation.success():a}createActivationSteps(e,n){return[Wt(n.id),...this.individualActivationSteps(e,n)]}createResolutionSteps(e,n){return[...this.individualResolutionSteps(e,n)]}}class Ir extends sn{constructor(){super(67616300,1)}individualConditions(e,n){var a,r;return e.lp.player<=1e3||(r=(a=n.stateOnField)==null?void 0:a.activatedEffects)!=null&&r.has(this.effectId)?i.Validation.failure(i.Validation.ERROR_CODES.ACTIVATION_CONDITIONS_NOT_MET):i.Validation.success()}individualActivationSteps(e,n){return[tn(1e3,"player")]}individualResolutionSteps(e,n){return[Ae(1)]}}const Or=(t,e,n,a)=>({id:`add-counter-${e}-${n}-${t}`,summary:"カウンターを置く",description:`魔力カウンターを${n}つ置きます`,notificationLevel:"silent",action:r=>{const s=_.Space.findCard(r.space,t);if(!s||!s.stateOnField)return i.Result.success(r,"カードが見つかりません");const c=s.stateOnField.counters,u=F.Counter.get(c,e);if(u>=a)return i.Result.success(r,"カウンターは既に最大数です");const p=Math.min(n,a-u),C=F.Counter.update(c,e,p),E={...s.stateOnField,counters:C},I=_.Space.updateCardStateInPlace(r.space,s,E);return i.Result.success({...r,space:I},`魔力カウンターを${p}つ置きました`)}}),Er=(t,e,n)=>({id:`remove-counter-${e}-${n}-${t}`,summary:"カウンターを取り除く",description:`魔力カウンターを${n}つ取り除きます`,notificationLevel:"info",action:a=>{const r=_.Space.findCard(a.space,t);if(!r||!r.stateOnField)return i.Result.failure(a,`Target card not found: ${t}`);const s=r.stateOnField.counters,c=F.Counter.get(s,e);if(c<n)return i.Result.failure(a,`Insufficient counters: needed ${n}, but only ${c} available.`);const u=F.Counter.update(s,e,-n),p={...r.stateOnField,counters:u},C=_.Space.updateCardStateInPlace(a.space,r,p);return i.Result.success({...a,space:C},`Removed ${n} ${e} counter(s) from card.`)}}),Mt=3;class yr extends sn{constructor(){super(70791313,1)}individualConditions(e,n){var s;const a=((s=n.stateOnField)==null?void 0:s.counters)??[];return F.Counter.get(a,"spell")<Mt?i.Validation.failure(i.Validation.ERROR_CODES.INSUFFICIENT_COUNTERS):i.Validation.success()}individualActivationSteps(e,n){return[Er(n.instanceId,"spell",Mt)]}individualResolutionSteps(e,n){return[Ae(1)]}}function Tr(){K.registerActivation(55144522,new $a),K.registerActivation(79571449,new er),K.registerActivation(67616300,new nr),K.registerActivation(70368879,new rr),K.registerActivation(33782437,new ir),K.registerActivation(85852291,new cr),K.registerActivation(74519184,new lr),K.registerActivation(90928333,new ur),K.registerActivation(73628505,new fr),K.registerActivation(98494543,new vr),K.registerActivation(93946239,new pr),K.registerActivation(98645731,new _r),K.registerActivation(59750328,new Cr),K.registerActivation(89997728,new gr),K.registerActivation(15259703,new hr),K.registerIgnition(67616300,new Ir),K.registerIgnition(70791313,new yr)}class Rr{constructor(){W(this,"isEffect",!0);W(this,"category","ActionPermission")}canApply(e){return e.space.fieldZone.some(n=>n.id===67616300&&F.Instance.isFaceUp(n))}checkPermission(e){return!1}}const br=70791313,Ar=3;class xr{constructor(){W(this,"isEffect",!0);W(this,"category","TriggerRule");W(this,"triggers",["spellActivated"])}canApply(e){return e.space.mainMonsterZone.some(a=>a.id===br&&F.Instance.isFaceUp(a))}createTriggerSteps(e,n){return[Or(n.instanceId,"spell",1,Ar)]}}function Dr(){qe.register(67616300,new Rr),qe.register(70791313,new xr)}Tr();Dr();class Nr{canExecuteCommand(e,...n){const a=rt();return new e(...n).canExecute(a).isValid}executeCommand(e,...n){const a=rt(),s=new e(...n).execute(a);return s.success&&(X.set(s.updatedState),s.effectSteps&&s.effectSteps.length>0&&De.startProcessing(s.effectSteps)),{success:s.success,message:s.message,error:s.error}}initializeGame(e){Oa(e)}getGameState(){return rt()}advancePhase(){return this.executeCommand(Qa)}canSummonMonster(e){return this.canExecuteCommand(Dt,e)}summonMonster(e){return this.executeCommand(Dt,e)}canSetMonster(e){return this.canExecuteCommand(Nt,e)}setMonster(e){return this.executeCommand(Nt,e)}canSetSpellTrap(e){return this.canExecuteCommand(kt,e)}setSpellTrap(e){return this.executeCommand(kt,e)}canActivateSpell(e){return this.canExecuteCommand(wt,e)}activateSpell(e){return this.executeCommand(wt,e)}canActivateIgnitionEffect(e){return this.canExecuteCommand(Vt,e)}activateIgnitionEffect(e){return this.executeCommand(Vt,e)}}const re=new Nr,kr=({params:t})=>{const{deckId:e}=t,{deckRecipe:n,deckData:a,uniqueCardIds:r}=gn(e);return console.log(`[PageLoad] Initializing game with deck: ${n.name}`),re.initializeGame(n),console.log("[PageLoad] Initial state:",re.getGameState()),{deckId:e,deckName:a.name,uniqueCardIds:r}},as=Object.freeze(Object.defineProperty({__proto__:null,load:kr},Symbol.toStringTag,{value:"Module"})),wr=ie(X,t=>t.phase),Vr=ie(X,t=>t.turn),Mr=ie(X,t=>t.lp.player),Fr=ie(X,t=>t.lp.opponent),Pr=ie(X,t=>t.space.hand.length),Lr=ie(X,t=>t.space.mainDeck.length);ie(X,t=>t.space.graveyard.length);ie(X,t=>t.space.mainMonsterZone.length+t.space.spellTrapZone.length+t.space.fieldZone.length);const Zr=ie(X,t=>t.result);ie(X,t=>t.space.mainDeck.length===0);ie(X,t=>t.space.hand.length===0);const Gr=ie(X,t=>t.space.hand);ie(X,t=>[...t.space.mainMonsterZone,...t.space.spellTrapZone,...t.space.fieldZone]);const Hr=ie(X,t=>t.space.graveyard);ie(X,t=>t.space.banished);const Ur=""+new URL("../assets/SpellCounter.pzkYCI1C.png",import.meta.url).href;var zr=b('<div class="absolute bottom-8 right-1 px-1 bg-green-900 text-white rounded-full flex items-center justify-center font-bold border-1 border-green-400 shadow-md z-10" data-testid="spell-counter-badge"><img alt="魔力カウンター" class="w-4 h-4"/> <span class="text-xs" data-testid="spell-counter-count"> </span></div>');function jr(t,e){const n=D(()=>e.count>0);var a=be(),r=ne(a);{var s=c=>{var u=zr(),p=d(u),C=g(p,2),E=d(C,!0);o(C),o(u),ae(()=>{Fe(u,"title",`魔力カウンター: ${e.count??""}`),Fe(p,"src",Ur),te(E,e.count)}),O(c,u)};Y(r,c=>{l(n)&&c(s)})}O(t,a)}var Br=(t,e,n)=>e(l(n)),qr=b("<button> </button>"),Qr=b('<div class="absolute -bottom-10 md:-bottom-14 left-1/2 -translate-x-1/2 flex flex-wrap justify-center gap-1 md:gap-2 z-10 max-w-[200px]"><!> <button class="btn btn-sm preset-tonal-warning">キャンセル</button></div>'),Wr=b('<div class="relative"><div class="transition-transform duration-300 hover:scale-105"><!> <!></div> <!></div>');function je(t,e){me(e,!0);let n=Ce(e,"size",3,"medium"),a=Ce(e,"showDetailOnClick",3,!0),r=Ce(e,"faceDown",3,!1),s=Ce(e,"rotation",3,0),c=Ce(e,"spellCounterCount",3,0);function u(){e.onSelect(e.card,e.instanceId)}function p(f){f.onClick(e.card,e.instanceId)}function C(f,S){const R=f||"filled",x=S||"primary";return{filled:{primary:"preset-filled-primary-500",secondary:"preset-filled-secondary-500",tertiary:"preset-filled-tertiary-500",success:"preset-filled-success-500",warning:"preset-filled-warning-500",error:"preset-filled-error-500",surface:"preset-filled-surface-500"},tonal:{primary:"preset-tonal-primary",secondary:"preset-tonal-secondary",tertiary:"preset-tonal-tertiary",success:"preset-tonal-success",warning:"preset-tonal-warning",error:"preset-tonal-error",surface:"preset-tonal-surface"},outlined:{primary:"preset-outlined-primary-500",secondary:"preset-outlined-secondary-500",tertiary:"preset-outlined-tertiary-500",success:"preset-outlined-success-500",warning:"preset-outlined-warning-500",error:"preset-outlined-error-500",surface:"preset-outlined-surface-500"}}[R][x]}var E=Wr(),I=d(E),m=d(I);ge(m,{get card(){return e.card},get size(){return n()},get faceDown(){return r()},get rotation(){return s()},clickable:!0,get isSelected(){return e.isSelected},onClick:u,get showDetailOnClick(){return a()},animate:!1});var w=g(m,2);{var V=f=>{jr(f,{get count(){return c()}})};Y(w,f=>{c()>0&&f(V)})}o(I);var P=g(I,2);{var U=f=>{var S=Qr(),R=d(S);Ie(R,17,()=>e.actionButtons,N=>N.label,(N,G)=>{var h=qr();h.__click=[Br,p,G];var v=d(h,!0);o(h),ae(y=>{pe(h,1,`btn btn-sm w-full border-2 border-gray-200 ${y??""} ${e.isActivatable?"":"opacity-50 cursor-not-allowed"}`),te(v,l(G).label)},[()=>C(l(G).style,l(G).color)]),O(N,h)});var x=g(R,2);x.__click=function(...N){var G;(G=e.onCancel)==null||G.apply(this,N)},o(S),O(f,S)};Y(P,f=>{e.isSelected&&f(U)})}o(E),O(t,E),_e()}Ne(["click"]);function Yr(t,e){e.onOpenChange(!1)}function Kr(t,e){ee(e,!l(e))}var Xr=b('<div class="relative"><div><!></div> <!></div>'),Jr=b('<div class="relative"><div><!></div></div>'),$r=b('<div class="flex gap-2 flex-wrap"><!></div>'),ei=b('<div class="text-center py-8"><p class="text-gray-500"> </p></div>'),ti=b('<header class="flex justify-between items-center mb-4"><h2 class="text-2xl sm:text-3xl font-bold mx-2"> </h2> <div class="flex items-center gap-2"><button type="button"><!> <span class="text-xs"> </span></button> <button type="button" class="btn preset-tonal rounded-full"><!></button></div></header> <div class="text-sm text-surface-600-300-token mb-2"> </div> <!>',1);function cn(t,e){me(e,!0);let n=Ce(e,"emptyMessage",3,"カードがありません"),a=Ce(e,"borderColor",3,"border-gray-400");const r=D(()=>e.cards.slice().reverse());let s=Se(!1);const c=D(()=>{const p=new Map;return l(r).forEach(C=>{const E=p.get(C.id);E?E.quantity+=1:p.set(C.id,{card:C,quantity:1})}),Array.from(p.values())});function u(p){e.onOpenChange(p.open)}Qe(t,{get open(){return e.open},onOpenChange:u,contentBase:"card bg-surface-100-900 p-6 mx-auto space-y-4 shadow-xl w-[95vw] md:max-w-4xl max-h-[90vh] overflow-auto",backdropClasses:"backdrop-blur-sm",content:C=>{var E=ti(),I=ne(E),m=d(I),w=d(m,!0);o(m);var V=g(m,2),P=d(V);P.__click=[Kr,s];var U=d(P);const f=D(()=>l(s)?"mdi:card-multiple":"mdi:cards");Tt(U,{get icon(){return l(f)},class:"size-4"});var S=g(U,2),R=d(S,!0);o(S),o(P);var x=g(P,2);x.__click=[Yr,e];var N=d(x);Tt(N,{icon:"mdi:close",class:"size-4"}),o(x),o(V),o(I);var G=g(I,2),h=d(G);o(G);var v=g(G,2);{var y=z=>{var q=$r(),k=d(q);{var M=L=>{var H=be(),J=ne(H);Ie(J,17,()=>l(c),({card:Q,quantity:$})=>Q.id,(Q,$)=>{let se=()=>l($).card,ce=()=>l($).quantity;var de=Xr(),ue=d(de),ke=d(ue);ge(ke,{get card(){return se()},size:"medium",showDetailOnClick:!0}),o(ue);var Le=g(ue,2);{var Ee=fe=>{Ge(fe,{get count(){return ce()},colorClasses:"bg-primary-200 text-primary-900"})};Y(Le,fe=>{ce()>1&&fe(Ee)})}o(de),ae(()=>pe(ue,1,`border-2 ${a()??""} rounded-lg shadow-md overflow-hidden`)),O(Q,de)}),O(L,H)},j=L=>{var H=be(),J=ne(H);Ie(J,17,()=>l(r),En,(Q,$)=>{var se=Jr(),ce=d(se),de=d(ce);ge(de,{get card(){return l($)},size:"medium",showDetailOnClick:!0}),o(ce),o(se),ae(()=>pe(ce,1,`border-2 ${a()??""} rounded-lg shadow-md overflow-hidden`)),O(Q,se)}),O(L,H)};Y(k,L=>{l(s)?L(M):L(j,!1)})}o(q),O(z,q)},B=z=>{var q=ei(),k=d(q),M=d(k,!0);o(k),o(q),ae(()=>te(M,n())),O(z,q)};Y(v,z=>{e.cards.length>0?z(y):z(B,!1)})}ae(()=>{te(w,e.title),pe(P,1,`btn btn-sm ${l(s)?"preset-filled-primary-500":"preset-tonal"}`),Fe(P,"title",l(s)?"個別表示に切り替え":"集約表示に切り替え"),te(R,l(s)?"集約":"個別"),te(h,`${e.cards.length??""}枚`)}),O(C,E)},$$slots:{content:!0}}),_e()}Ne(["click"]);var ni=(t,e)=>t.key==="Enter"&&e(),ai=b('<div class="absolute inset-1"><!></div> <!>',1),ri=b('<div class="h-full flex items-center justify-center p-1 relative" style="filter: grayscale(0.8) brightness(0.7) contrast(1.2);"><img alt="墓地" class="w-full h-full object-cover opacity-30 rounded-sm"/> <div class="absolute inset-0 flex items-center justify-center"><span class="text-xs text-surface-600-300-token text-center select-none drop-shadow-lg"> </span></div></div> <!>',1),ii=b('<div role="button" tabindex="0"><!></div> <!>',1);function si(t,e){me(e,!0);let n=Ce(e,"size",3,"medium");const a=ot();let r=Se(!1);const s=D(()=>e.cards.length>0?e.cards[e.cards.length-1]:null);function c(){ee(r,!0)}function u(f){ee(r,f,!0)}let p=Se(!1);function C(){ee(p,!0)}function E(){ee(p,!1)}var I=ii(),m=ne(I);m.__click=c,m.__keydown=[ni,c];var w=d(m);{var V=f=>{var S=ai(),R=ne(S),x=d(R);ge(x,{get card(){return l(s)},get size(){return n()},clickable:!1}),o(R);var N=g(R,2);Ge(N,{get count(){return e.cards.length}}),O(f,S)},P=f=>{var S=ri(),R=ne(S),x=d(R),N=g(x,2),G=d(N),h=d(G,!0);o(G),o(N),o(R);var v=g(R,2);Ge(v,{get count(){return e.cards.length}}),ae(()=>{Fe(x,"src",ct),te(h,a?"GY":"墓地")}),O(f,S)};Y(w,f=>{l(s)?f(V):f(P,!1)})}o(m);var U=g(m,2);cn(U,{get cards(){return e.cards},get open(){return l(r)},onOpenChange:u,title:"墓地",borderColor:"border-gray-400"}),ae(()=>pe(m,1,`
    ${st[n()]??""}
    relative
    border-2 border-dashed border-gray-400
    rounded-lg
    bg-gray-100 dark:bg-gray-800
    transition-all duration-300
    cursor-pointer
    hover:border-gray-600 hover:bg-gray-200 dark:hover:bg-gray-700
    ${l(p)?"scale-105 shadow-lg":""}
  `)),Be("mouseenter",m,C),Be("mouseleave",m,E),O(t,I),_e()}Ne(["click","keydown"]);var ci=(t,e)=>t.key==="Enter"&&e(),oi=b('<div role="button" tabindex="0"><div class="h-full flex items-center justify-center p-1 relative"><img alt="EXデッキ" class="w-full h-full object-cover rounded-sm"/> <div class="absolute inset-0 flex items-center justify-center"><span class="text-xs text-white font-bold text-center select-none drop-shadow-lg">EX</span></div></div> <!></div> <!>',1);function li(t,e){me(e,!0);let n=Ce(e,"size",3,"medium"),a=Se(!1);function r(){ee(a,!0)}function s(P){ee(a,P,!0)}let c=Se(!1);function u(){ee(c,!0)}function p(){ee(c,!1)}var C=oi(),E=ne(C);E.__click=r,E.__keydown=[ci,r];var I=d(E),m=d(I);Pt(2),o(I);var w=g(I,2);Ge(w,{get count(){return e.cards.length}}),o(E);var V=g(E,2);cn(V,{get cards(){return e.cards},get open(){return l(a)},onOpenChange:s,title:"EXデッキ",borderColor:"border-purple-400"}),ae(()=>{pe(E,1,`
    ${st[n()]??""}
    relative
    border-2 border-dashed border-gray-400
    rounded-lg
    bg-gray-100 dark:bg-gray-800
    transition-all duration-300
    cursor-pointer
    ${l(c)?"scale-105 shadow-lg":""}
  `),Fe(m,"src",ct)}),Be("mouseenter",E,u),Be("mouseleave",E,p),O(t,C),_e()}Ne(["click","keydown"]);var di=b('<div role="img"><div class="h-full flex items-center justify-center p-1 relative"><img alt="メインデッキ" class="w-full h-full object-cover rounded-sm"/> <div class="absolute inset-0 flex items-center justify-center"><span class="text-xs text-white font-bold text-center select-none drop-shadow-lg">Deck</span></div></div> <!></div>');function ui(t,e){me(e,!0);let n=Ce(e,"size",3,"medium");var a=di(),r=d(a),s=d(r);Pt(2),o(r);var c=g(r,2);Ge(c,{get count(){return e.cardCount}}),o(a),ae(()=>{pe(a,1,`
    ${st[n()]??""}
    relative
    border-2 border-dashed border-gray-400
    rounded-lg
    bg-gray-100 dark:bg-gray-800
  `),Fe(s,"src",ct)}),O(t,a),_e()}var fi=b('<div class="relative"><div style="filter: sepia(0.3) hue-rotate(90deg) saturate(1.5) brightness(0.9);"><!></div></div>'),vi=b('<div class="flex justify-center"><!></div>'),pi=b('<div class="relative"><div style="filter: sepia(0.5) hue-rotate(30deg) saturate(1.8) brightness(0.85);"><!></div></div>'),mi=b('<div class="flex justify-center"><!></div>'),_i=b('<div class="relative"><div style="filter: sepia(0.4) hue-rotate(200deg) saturate(2) brightness(0.8);"><!></div></div>'),Ci=b('<div class="flex justify-center"><!></div>'),gi=b('<div class="flex justify-center"><!></div>'),Si=b('<div class="flex justify-center"><!></div>'),hi=b('<div class="flex justify-center"><!></div>'),Ii=b('<div class="grid grid-cols-4 gap-1 mb-2"><!> <!> <!> <!></div> <div class="grid grid-cols-5 gap-1 mb-2"></div> <div class="grid grid-cols-5 gap-1 mb-2"></div>',1),Oi=b('<div class="grid grid-cols-7 gap-2 mb-4"><!> <!> <!></div> <div class="grid grid-cols-7 gap-2 mb-4"><!> <!> <!></div>',1),Ei=b('<div class="card p-2 max-w-6xl mx-auto"><div class="transition-all duration-300"><!></div></div>');function yi(t,e){me(e,!0);const n=(h,v=at)=>{var y=vi(),B=d(y);{var z=k=>{const M=D(()=>e.selectedFieldCardInstanceId===e.fieldCards[0].instanceId),j=D(()=>U(e.fieldCards[0].instanceId,e.fieldCards[0].faceDown).length>0),L=D(()=>U(e.fieldCards[0].instanceId,e.fieldCards[0].faceDown)),H=D(()=>e.onCancelFieldCardSelection||(()=>{}));je(k,{get card(){return e.fieldCards[0].card},get instanceId(){return e.fieldCards[0].instanceId},get faceDown(){return e.fieldCards[0].faceDown},get isSelected(){return l(M)},get isActivatable(){return l(j)},onSelect:m,get actionButtons(){return l(L)},get onCancel(){return l(H)},get size(){return I},showDetailOnClick:!0})},q=k=>{var M=fi(),j=d(M),L=d(j);ge(L,{placeholder:!0,get placeholderText(){return v()},get size(){return I}}),o(j),o(M),O(k,M)};Y(B,k=>{e.fieldCards.length>0?k(z):k(q,!1)})}o(y),O(h,y)},a=(h,v=at)=>{var y=mi(),B=d(y);{var z=k=>{const M=D(()=>e.monsterCards[v()].rotation||0),j=D(()=>e.selectedFieldCardInstanceId===e.monsterCards[v()].instanceId),L=D(()=>f(e.monsterCards[v()].instanceId).length>0),H=D(()=>f(e.monsterCards[v()].instanceId)),J=D(()=>e.onCancelFieldCardSelection||(()=>{})),Q=D(()=>e.monsterCards[v()].spellCounterCount||0);je(k,{get card(){return e.monsterCards[v()].card},get instanceId(){return e.monsterCards[v()].instanceId},get faceDown(){return e.monsterCards[v()].faceDown},get rotation(){return l(M)},get isSelected(){return l(j)},get isActivatable(){return l(L)},onSelect:m,get actionButtons(){return l(H)},get onCancel(){return l(J)},get size(){return I},showDetailOnClick:!0,get spellCounterCount(){return l(Q)}})},q=k=>{var M=pi(),j=d(M),L=d(j);const H=D(()=>v()+1);ge(L,{placeholder:!0,get placeholderText(){return`M${l(H)??""}`},get size(){return I}}),o(j),o(M),O(k,M)};Y(B,k=>{e.monsterCards[v()]?k(z):k(q,!1)})}o(y),O(h,y)},r=(h,v=at)=>{var y=Ci(),B=d(y);{var z=k=>{var M=be(),j=ne(M);{var L=J=>{const Q=D(()=>e.selectedFieldCardInstanceId===e.spellTrapCards[v()].instanceId),$=D(()=>P(e.spellTrapCards[v()].instanceId).length>0),se=D(()=>P(e.spellTrapCards[v()].instanceId)),ce=D(()=>e.onCancelFieldCardSelection||(()=>{}));je(J,{get card(){return e.spellTrapCards[v()].card},get instanceId(){return e.spellTrapCards[v()].instanceId},faceDown:!0,get isSelected(){return l(Q)},get isActivatable(){return l($)},onSelect:m,get actionButtons(){return l(se)},get onCancel(){return l(ce)},get size(){return I},showDetailOnClick:!0})},H=J=>{ge(J,{get card(){return e.spellTrapCards[v()].card},faceDown:!1,get size(){return I},clickable:!0,showDetailOnClick:!0,onClick:()=>e.spellTrapCards[v()]&&m(e.spellTrapCards[v()].card,e.spellTrapCards[v()].instanceId)})};Y(j,J=>{e.spellTrapCards[v()].faceDown?J(L):J(H,!1)})}O(k,M)},q=k=>{var M=_i(),j=d(M),L=d(j);const H=D(()=>v()+1);ge(L,{placeholder:!0,get placeholderText(){return`S${l(H)??""}`},get size(){return I}}),o(j),o(M),O(k,M)};Y(B,k=>{e.spellTrapCards[v()]?k(z):k(q,!1)})}o(y),O(h,y)},s=h=>{var v=gi(),y=d(v);si(y,{get cards(){return e.graveyardCards},get size(){return I}}),o(v),O(h,v)},c=h=>{var v=Si(),y=d(v);li(y,{get cards(){return e.extraDeckCards},get size(){return I}}),o(v),O(h,v)},u=h=>{var v=hi(),y=d(v);ui(y,{get cardCount(){return e.deckCards},get size(){return I}}),o(v),O(h,v)},C=[...Array(5).keys()],E=ot(),I=E?"small":"medium";function m(h,v){e.onFieldCardClick&&e.onFieldCardClick(h,v)}function w(h){return re.canActivateSpell(h)}function V(h){return re.canActivateIgnitionEffect(h)}function P(h){return w(h)?[{label:"発動",style:"filled",color:"primary",onClick:e.onActivateSetSpell||(()=>{})}]:[]}function U(h,v){return v?w(h)?[{label:"発動",style:"filled",color:"primary",onClick:e.onActivateSetSpell||(()=>{})}]:[]:V(h)?[{label:"効果発動",style:"filled",color:"primary",onClick:e.onActivateIgnitionEffect||(()=>{})}]:[]}function f(h){return V(h)?[{label:"効果発動",style:"filled",color:"primary",onClick:e.onActivateIgnitionEffect||(()=>{})}]:[]}var S=Ei(),R=d(S),x=d(R);{var N=h=>{var v=Ii(),y=ne(v),B=d(y);n(B,()=>"F");var z=g(B,2);c(z);var q=g(z,2);u(q);var k=g(q,2);s(k),o(y);var M=g(y,2);Ie(M,20,()=>C,L=>L,(L,H)=>{a(L,()=>H)}),o(M);var j=g(M,2);Ie(j,20,()=>C,L=>L,(L,H)=>{r(L,()=>H)}),o(j),O(h,v)},G=h=>{var v=Oi(),y=ne(v),B=d(y);n(B,()=>"フィールド");var z=g(B,2);Ie(z,16,()=>C,H=>H,(H,J)=>{a(H,()=>J)});var q=g(z,2);s(q),o(y);var k=g(y,2),M=d(k);c(M);var j=g(M,2);Ie(j,16,()=>C,H=>H,(H,J)=>{r(H,()=>J)});var L=g(j,2);u(L),o(k),O(h,v)};Y(x,h=>{E?h(N):h(G,!1)})}o(R),o(S),O(t,S),_e()}var Ti=b('<div class="text-center text-sm opacity-50">No cards in hand</div>'),Ri=b("<div></div>");function bi(t,e){me(e,!0);const n=ot(),a=n?"small":"medium";function r(f){return re.canActivateSpell(f)}function s(f){return re.canSummonMonster(f)}function c(f){return re.canSetMonster(f)}function u(f){return re.canSetSpellTrap(f)}function p(f){const S={1:"grid-cols-1",2:"grid-cols-2",3:"grid-cols-3",4:"grid-cols-4",5:"grid-cols-5",6:"grid-cols-6",7:"grid-cols-7",8:"grid-cols-8",9:"grid-cols-9",10:"grid-cols-10"};if(f<=0)return"grid-cols-1";if(n){if(f>=5)return"grid-cols-5"}else if(f>=10)return"grid-cols-10";return S[f]}function C(f,S){const R=e.selectedHandCardInstanceId===S?null:S;e.onHandCardSelect(R)}function E(f,S){e.onCardClick(f,S),e.onHandCardSelect(null)}function I(f,S){e.onSummonMonster(f,S),e.onHandCardSelect(null)}function m(f,S){e.onSetMonster(f,S),e.onHandCardSelect(null)}function w(f,S){e.onSetSpellTrap(f,S),e.onHandCardSelect(null)}function V(){e.onHandCardSelect(null)}function P(f,S){const R=[];return f.type==="monster"?(s(S)&&R.push({label:"召喚",style:"filled",color:"primary",onClick:I}),c(S)&&R.push({label:"セット",style:"filled",color:"primary",onClick:m})):(f.type==="spell"||f.type==="trap")&&(r(S)&&R.push({label:"発動",style:"filled",color:"primary",onClick:E}),u(S)&&R.push({label:"セット",style:"filled",color:"primary",onClick:w})),R}var U=Ri();Ie(U,21,()=>e.cards,({card:f,instanceId:S})=>S,(f,S)=>{let R=()=>l(S).card,x=()=>l(S).instanceId;var N=be(),G=ne(N);{var h=y=>{const B=D(()=>e.selectedHandCardInstanceId===x()),z=D(()=>P(R(),x()).length>0),q=D(()=>P(R(),x()));je(y,{get card(){return R()},get instanceId(){return x()},get isSelected(){return l(B)},get isActivatable(){return l(z)},onSelect:C,get actionButtons(){return l(q)},onCancel:V,get size(){return a}})},v=y=>{ge(y,{placeholder:!0,placeholderText:"...",get size(){return a}})};Y(G,y=>{R()?y(h):y(v,!1)})}O(f,N)},f=>{var S=Ti();O(f,S)}),o(U),ae(f=>pe(U,1,`grid ${f??""} gap-2 mb-16`),[()=>p(e.handCardCount)]),O(t,U),_e()}function Ai(t,e){var n;(n=e.config)==null||n.onConfirm()}var xi=b('<button class="btn variant-ghost">キャンセル</button>'),Di=b('<header class="text-center"><h2 class="h3 font-bold text-primary-600-300-token"> </h2></header> <article class="text-center"><p class="text-lg"> </p></article> <footer class="flex justify-center gap-3"><!> <button class="btn variant-filled-primary">OK</button></footer>',1);function Ni(t,e){me(e,!0);const n=D(()=>{var s;return((s=e.config)==null?void 0:s.cancelable)??!1});function a(){var s,c;(c=(s=e.config)==null?void 0:s.onCancel)==null||c.call(s)}function r(s){!s.open&&e.isOpen&&l(n)&&a()}Qe(t,{get open(){return e.isOpen},onOpenChange:r,contentBase:"card bg-surface-50 dark:bg-surface-900 p-6 space-y-4 max-w-md shadow-2xl border-2 border-surface-300 dark:border-surface-700",backdropClasses:"!bg-black/80 backdrop-blur-md",modal:!0,trapFocus:!0,get closeOnEscape(){return l(n)},preventScroll:!0,content:c=>{var u=be(),p=ne(u);{var C=E=>{var I=Di(),m=ne(I),w=d(m),V=d(w,!0);o(w),o(m);var P=g(m,2),U=d(P),f=d(U,!0);o(U),o(P);var S=g(P,2),R=d(S);{var x=G=>{var h=xi();h.__click=a,O(G,h)};Y(R,G=>{l(n)&&G(x)})}var N=g(R,2);N.__click=[Ai,e],o(S),ae(()=>{te(V,e.config.summary),te(f,e.config.description)}),O(E,I)};Y(p,E=>{e.config&&E(C)})}O(c,u)},$$slots:{content:!0}}),_e()}Ne(["click"]);function ki(t,e,n,a){!e.config||!l(n)()||e.config.onConfirm(Array.from(l(a)))}var wi=b('<button class="btn btn-sm btn-circle btn-ghost">✕</button>'),Vi=b("<div><!></div>"),Mi=b('<button class="btn btn-ghost">キャンセル</button>'),Fi=b('<div class="flex justify-between items-center mb-4"><h3 class="font-bold text-lg"> </h3> <!></div> <p class="text-sm text-surface-600-300-token mb-4"> </p> <div class="flex justify-between items-center mb-4 p-3 bg-surface-200 dark:bg-surface-800 rounded-lg border border-surface-300 dark:border-surface-600"><span class="text-sm font-semibold"> </span></div> <div class="min-h-[200px] max-h-[400px] overflow-y-auto mb-6"><div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3"></div></div> <div class="flex justify-end gap-3 mt-6"><!> <button class="btn btn-primary">確定</button></div>',1);function Pi(t,e){me(e,!0);let n=Se(hn(new Set));it(()=>{e.isOpen&&ee(n,new Set,!0)});const a=D(()=>l(n).size),r=D(()=>{var m;return((m=e.config)==null?void 0:m.cancelable)??!1}),s=D(()=>()=>e.config?l(a)>=e.config.minCards&&l(a)<=e.config.maxCards:!1);function c(m){return l(n).has(m)}function u(m){return e.config?l(n).has(m)?!0:l(n).size<e.config.maxCards:!1}function p(m){!m.open&&e.isOpen&&l(r)&&E()}function C(m){if(!e.config||!e.config.availableCards.some(U=>U.instanceId===m))return;const V=u(m),P=c(m);if(V||P){const U=new Set(l(n));P?U.delete(m):U.add(m),ee(n,U,!0)}}function E(){var m,w;(w=(m=e.config)==null?void 0:m.onCancel)==null||w.call(m)}function I(m){var V;const w=(V=e.config)==null?void 0:V.availableCards.find(P=>P.instanceId===m);if(w)return Me(w.id)}Qe(t,{get open(){return e.isOpen},onOpenChange:p,contentBase:"card bg-surface-50 dark:bg-surface-900 p-6 space-y-4 w-[95vw] md:max-w-4xl max-h-[90vh] overflow-auto shadow-2xl border-2 border-surface-300 dark:border-surface-700",backdropClasses:"!bg-black/80 backdrop-blur-md",modal:!0,trapFocus:!0,get closeOnEscape(){return l(r)},preventScroll:!0,content:w=>{var V=be(),P=ne(V);{var U=f=>{var S=Fi(),R=ne(S),x=d(R),N=d(x,!0);o(x);var G=g(x,2);{var h=Q=>{var $=wi();$.__click=E,O(Q,$)};Y(G,Q=>{l(r)&&Q(h)})}o(R);var v=g(R,2),y=d(v,!0);o(v);var B=g(v,2),z=d(B),q=d(z);o(z),o(B);var k=g(B,2),M=d(k);Ie(M,21,()=>e.config.availableCards,Q=>Q.instanceId,(Q,$)=>{var se=be();const ce=D(()=>c(l($).instanceId)),de=D(()=>u(l($).instanceId)),ue=D(()=>I(l($).instanceId));var ke=ne(se);{var Le=Ee=>{var fe=Vi();let we;var He=d(fe);ge(He,{get card(){return l(ue)},size:"small",clickable:!0,selectable:!1,get isSelected(){return l(ce)},animate:!0,onClick:()=>C(l($).instanceId)}),o(fe),ae($e=>we=pe(fe,1,"",null,we,$e),[()=>({"opacity-50":!l(de)&&!l(ce)})]),O(Ee,fe)};Y(ke,Ee=>{l(ue)&&Ee(Le)})}O(Q,se)}),o(M),o(k);var j=g(k,2),L=d(j);{var H=Q=>{var $=Mi();$.__click=E,O(Q,$)};Y(L,Q=>{l(r)&&Q(H)})}var J=g(L,2);J.__click=[ki,e,s,n],o(j),ae(Q=>{te(N,e.config.summary),te(y,e.config.description),te(q,`選択中: ${l(a)??""} / ${e.config.maxCards??""}枚`),J.disabled=Q},[()=>!l(s)()]),O(f,S)};Y(P,f=>{e.config&&f(U)})}O(w,V)},$$slots:{content:!0}}),_e()}Ne(["click"]);var Li=b('<span class="text-warning-600 dark:text-warning-400">Draw</span>'),Zi=b("Winner: <span> </span>",1),Gi=b('<p class="text-2xl font-bold"><!></p>'),Hi=b('<p class="text-base opacity-75"><span class="font-semibold">Reason:</span> </p>'),Ui=b('<p class="text-base"> </p>'),zi=b('<header class="text-center"><h2>Game Over!</h2></header> <article class="space-y-4 text-center"><!> <!> <!></article> <footer class="flex justify-center"><button class="btn variant-filled-primary">閉じる</button></footer>',1);function ji(t,e){me(e,!0);function n(){e.onClose()}function a(c){c.open||n()}function r(){return e.winner==="player"?"border-success-500":e.winner==="opponent"?"border-error-500":e.winner==="draw"?"border-warning-500":"border-surface-500"}const s=D(r);Qe(t,{get open(){return e.isOpen},onOpenChange:a,get contentBase(){return`card bg-surface-50 dark:bg-surface-900 p-8 space-y-6 max-w-lg shadow-2xl border-4 ${l(s)??""}`},backdropClasses:"!bg-black/80 backdrop-blur-md",modal:!0,trapFocus:!0,closeOnEscape:!0,preventScroll:!0,content:u=>{var p=zi(),C=ne(p),E=d(C);o(C);var I=g(C,2),m=d(I);{var w=x=>{var N=Gi(),G=d(N);{var h=y=>{var B=Li();O(y,B)},v=y=>{var B=Zi(),z=g(ne(B)),q=d(z,!0);o(z),ae(()=>{pe(z,1,yn(e.winner==="player"?"text-success-600 dark:text-success-400":"text-error-600 dark:text-error-400")),te(q,e.winner==="player"?"You":"Opponent")}),O(y,B)};Y(G,y=>{e.winner==="draw"?y(h):y(v,!1)})}o(N),O(x,N)};Y(m,x=>{e.winner&&x(w)})}var V=g(m,2);{var P=x=>{var N=Hi(),G=g(d(N));o(N),ae(()=>te(G,` ${e.reason??""}`)),O(x,N)};Y(V,x=>{e.reason&&x(P)})}var U=g(V,2);{var f=x=>{var N=Ui(),G=d(N,!0);o(N),ae(()=>te(G,e.message)),O(x,N)};Y(U,x=>{e.message&&x(f)})}o(I);var S=g(I,2),R=d(S);R.__click=n,o(S),ae(()=>pe(E,1,`h2 font-bold ${e.winner==="player"?"text-success-600 dark:text-success-400":"text-error-600 dark:text-error-400"}`)),O(u,p)},$$slots:{content:!0}}),_e()}Ne(["click"]);var Bi=b('<div class="container mx-auto p-4"><main class="max-w-4xl mx-auto space-y-2"><div class="grid grid-cols-1 md:grid-cols-2 gap-4"><div class="card px-4"><h1 class="text-2xl font-bold"> </h1></div> <div class="card px-4 space-y-4"><div class="space-y-2"><div class="flex justify-start space-x-4"><span>Now:</span> <span class="font-bold" data-testid="current-phase"> </span></div> <div class="flex justify-between"><span>自分 LP:</span> <span class="font-bold text-success-500"> </span> <span>相手 LP:</span> <span class="font-bold text-error-500"> </span></div></div></div></div> <!> <div class="card px-4 space-y-4"><h2 class="text-xl font-bold"> </h2> <!></div> <details class="card p-4"><summary class="cursor-pointer font-bold">Debug Info</summary> <div class="mt-4 space-y-4"><pre class="text-xs overflow-auto"> </pre></div></details></main></div> <!> <!> <!>',1);function rs(t,e){me(e,!0);const[n,a]=On(),r=()=>ve(Vr,"$currentTurn",n),s=()=>ve(wr,"$currentPhase",n),c=()=>ve(Zr,"$gameResult",n),u=()=>ve(Gr,"$handCardInstances",n),p=()=>ve(Hr,"$graveyardCardInstances",n),C=()=>ve(X,"$gameStateStore",n),E=()=>ve(Mr,"$playerLP",n),I=()=>ve(Fr,"$opponentLP",n),m=()=>ve(Lr,"$deckCardCount",n),w=()=>ve(Pr,"$handCardCount",n),V=()=>ve(M,"$effectQueueState",n);In(async()=>{await Sn(e.data.uniqueCardIds),De.registerNotificationHandler({showInfo:(Z,A)=>{xe(A)},showInteractive:()=>{}})});async function P(){for(let Z=0;Z<2;Z++){await new Promise(T=>setTimeout(T,300));const A=re.advancePhase();if(A.success)console.log(`[Simulator] ${A.message}`),A.message&&xe(A.message);else{Te(A.error||"フェーズ移行に失敗しました");break}}}let U=Se(!1);it(()=>{r()===1&&s()==="draw"&&!l(U)&&!c().isGameOver&&(P(),ee(U,!0))});let f=Se(!1);it(()=>{c().isGameOver&&ee(f,!0)});function S(){if(c().isGameOver)return"ゲーム終了";function Z(A){return{draw:"ドローフェイズ",standby:"スタンバイフェイズ",main1:"メインフェイズ1",end:"エンドフェイズ"}[A]||A}return Z(s())}function R(Z,A){const T=re.activateSpell(A);T.success||Te(T.error||"発動に失敗しました")}function x(Z,A){const T=re.summonMonster(A);T.success?xe(T.message||`${Z.name}を召喚しました`):Te(T.error||"召喚に失敗しました")}function N(Z,A){const T=re.setMonster(A);T.success?xe(`${Z.name}をセットしました`):Te(T.error||"セットに失敗しました")}function G(Z,A){const T=re.setSpellTrap(A);T.success?xe(`${Z.name}をセットしました`):Te(T.error||"セットに失敗しました")}let h=Se(null),v=Se(null);function y(Z){ee(h,Z,!0),ee(v,null)}function B(Z,A){const T=re.getGameState();if(![...T.space.mainMonsterZone,...T.space.spellTrapZone,...T.space.fieldZone].find(Ue=>Ue.instanceId===A)){Te("Card not found on field");return}ee(h,null),ee(v,l(v)===A?null:A,!0)}function z(Z,A){const T=re.activateSpell(A);T.success?xe(T.message||`${Z.name}を発動しました`):Te(T.error||"発動に失敗しました"),ee(v,null)}function q(Z,A){const T=re.activateIgnitionEffect(A);T.success?xe(T.message||`${Z.name}の効果を発動しました`):Te(T.error||"効果発動に失敗しました"),ee(v,null)}function k(){ee(v,null)}const M=De,j=D(()=>u().map(Z=>({card:Me(Z.id),instanceId:Z.instanceId}))),L=D(()=>p().map(Z=>Me(Z.id)).filter(Z=>Z!==void 0)),H=D(()=>C().space.fieldZone.map(A=>{const T=Me(A.id);return T?{card:T,instanceId:A.instanceId,faceDown:F.Instance.isFaceDown(A)}:null}).filter(A=>A!==null)),J=D(()=>{const Z=C().space.mainMonsterZone,A=Array(5).fill(null);return Z.forEach((T,ye)=>{var Ve,Ue;if(ye<5){const Ot=Me(T.id);Ot&&(A[ye]={card:Ot,instanceId:T.instanceId,faceDown:F.Instance.isFaceDown(T),rotation:((Ve=T.stateOnField)==null?void 0:Ve.battlePosition)==="defense"?270:0,spellCounterCount:F.Counter.get(((Ue=T.stateOnField)==null?void 0:Ue.counters)??[],"spell")})}}),A}),Q=D(()=>{const Z=C().space.spellTrapZone,A=Array(5).fill(null);return Z.forEach((T,ye)=>{if(ye<5){const Ve=Me(T.id);Ve&&(A[ye]={card:Ve,instanceId:T.instanceId,faceDown:F.Instance.isFaceDown(T)})}}),A});var $=Bi(),se=ne($),ce=d(se),de=d(ce),ue=d(de),ke=d(ue),Le=d(ke);o(ke),o(ue);var Ee=g(ue,2),fe=d(Ee),we=d(fe),He=g(d(we),2),$e=d(He,!0);o(He),o(we);var pt=g(we,2),et=g(d(pt),2),on=d(et,!0);o(et);var mt=g(et,4),ln=d(mt,!0);o(mt),o(pt),o(fe),o(Ee),o(de);var _t=g(de,2);yi(_t,{get deckCards(){return m()},extraDeckCards:[],get graveyardCards(){return l(L)},get fieldCards(){return l(H)},get monsterCards(){return l(J)},get spellTrapCards(){return l(Q)},get selectedFieldCardInstanceId(){return l(v)},onFieldCardClick:B,onActivateSetSpell:z,onActivateIgnitionEffect:q,onCancelFieldCardSelection:k});var tt=g(_t,2),nt=d(tt),dn=d(nt);o(nt);var un=g(nt,2);bi(un,{get cards(){return l(j)},get handCardCount(){return w()},get currentPhase(){return s()},get isGameOver(){return c().isGameOver},get selectedHandCardInstanceId(){return l(h)},onCardClick:R,onSummonMonster:x,onSetMonster:N,onSetSpellTrap:G,onHandCardSelect:y}),o(tt);var Ct=g(tt,2),gt=g(d(Ct),2),St=d(gt),fn=d(St,!0);o(St),o(gt),o(Ct),o(ce),o(se);var ht=g(se,2);const vn=D(()=>V().confirmationConfig!==null);Ni(ht,{get isOpen(){return l(vn)},get config(){return V().confirmationConfig}});var It=g(ht,2);const pn=D(()=>V().cardSelectionConfig!==null);Pi(It,{get isOpen(){return l(pn)},get config(){return V().cardSelectionConfig}});var mn=g(It,2);ji(mn,{get isOpen(){return l(f)},get winner(){return c().winner},get reason(){return c().reason},get message(){return c().message},onClose:()=>{ee(f,!1)}}),ae((Z,A,T,ye)=>{te(Le,`Deck: ${e.data.deckName??""}`),te($e,Z),te(on,A),te(ln,T),te(dn,`手札 (${w()??""} 枚)`),te(fn,ye)},[S,()=>E().toLocaleString(),()=>I().toLocaleString(),()=>JSON.stringify(re.getGameState(),null,2)]),O(t,$),_e(),a()}export{rs as component,as as universal};
