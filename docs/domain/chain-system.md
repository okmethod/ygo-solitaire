# チェーンシステム

**実装箇所**: `application/stores/effectQueueStore.ts`
**関連資料**: [効果モデル](./effect-model.md)

---

## 概要

チェーンシステムは、複数の効果が発動した際に、その処理順序を決定する仕組み。
プレイヤーは交互に効果をチェーンに積み、両者がパスした時点でチェーンを逆順に解決する。

本プロジェクトは「先行 1 ターン目のソリティア」がスコープのため、以下はスコープ外としている。

- **相手のチェーン介入なし**: 自分の効果のみ考慮、優先権制御も不要
- **SS3（カウンター罠）**: 先行1ターン目では原則罠カードは発動不可

---

## チェーンブロック

チェーンブロックとは、チェーン上に積まれる 1 つの処理単位。
「カードの発動」または「効果の発動」によって生成される。

チェーンブロックを作る処理の詳細は [効果モデル > Chainable Actions](./effect-model.md) を参照。

---

## スペルスピード

効果の発動速度を表す指標。チェーンを組む際のルールとして使用される。

- 同じスペルスピード以上の効果のみ、チェーンできる
- SS1 の効果はチェーン 1 にしか置けない（自らチェーンを開始することしかできない）
- SS3 のカウンター罠には、SS3 でしかチェーンできない

| スペルスピード | 対象                                                       |
| -------------- | ---------------------------------------------------------- |
| **SS1**        | 通常・装備・フィールド・永続魔法の発動、起動効果、誘発効果 |
| **SS2**        | 速攻魔法の発動、誘発即時効果、通常罠、永続罠               |
| **SS3**        | カウンター罠                                               |

---

## チェーンの流れ

### 1. チェーン構築

```
[チェーン1] 効果Aの発動を宣言
    ↓
[相手にチェーンの機会]
    ↓ チェーンする場合
[チェーン2] 効果Bの発動を宣言
    ↓
[自分にチェーンの機会]
    ↓ チェーンする場合
[チェーン3] 効果Cの発動を宣言
    ↓
... 繰り返し ...
    ↓
両プレイヤーがパス → チェーン解決へ
```

**チェーン構築時の注意点**

- `ACTIVATION`（発動コスト）は、構築時に直ちに処理する
- 「対象をとる効果」は、発動時に対象を決定し、解決時には変更できない
- 効果が無効になったとしても、発動コストは無効にならない

### 2. チェーン解決

チェーンは **LIFO（Last In, First Out）** で解決される。

```
[チェーン3] 効果Cを解決
    ↓
[チェーン2] 効果Bを解決
    ↓
[チェーン1] 効果Aを解決
    ↓
チェーン終了
```

### 解決時の注意点

- `RESOLUTION` を処理する
- 「対象をとる効果」で決めた対象が、解決時に対象が不在になった場合の処理はカードによって異なる
  - 残った対象にのみ適用する、1枚でも欠けたら不発になる、前の処理が失敗したら中断する、等
- 「対象をとらない効果」は、解決時に対象を選ぶ
- チェーン中で無効化された効果は解決されない

---

## タイミング

誘発効果・誘発即時効果には、発動タイミングに関するルールがある。

### 「する」と「できる」

| 表記         | 分類     | 特徴                             |
| ------------ | -------- | -------------------------------- |
| **〜する**   | 強制効果 | タイミングを逃さない             |
| **〜できる** | 任意効果 | 「タイミングを逃す」可能性がある |

### 「時」と「場合」

| 表記           | タイミング           | 特徴                             |
| -------------- | -------------------- | -------------------------------- |
| **〜した時**   | 直後のみ             | 「タイミングを逃す」可能性がある |
| **〜した場合** | 一連の処理の後でも可 | タイミングを逃さない             |

### タイミングを逃す例

「〜した時」に「〜できる」効果は、そのトリガーが「最後に起きたこと」でない場合、発動できない。

```
[チェーン構築]: カードAを破壊し、その後ドローする効果を発動
    ↓
[チェーン解決]：カードAが破壊される → ドローする
    ↓
カードAが「破壊された時」「〜できる」の効果は、タイミングを逃す
（最後の処理は「ドロー」であり、「破壊」ではないため）
```

---

## 同時に複数の効果がトリガーした場合

複数の効果が同時にトリガー条件を満たした場合、以下の順序でチェーンを組む。

1. **ターンプレイヤーの強制効果**
2. **非ターンプレイヤーの強制効果**
3. **ターンプレイヤーの任意効果**（順番は任意）
4. **非ターンプレイヤーの任意効果**（順番は任意）
