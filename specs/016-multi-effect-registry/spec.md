# Feature Specification: 複数効果登録対応レジストリ

**Feature Branch**: `016-multi-effect-registry`
**Created**: 2026-01-28
**Status**: Draft
**Input**: ChainableActionRegistryを拡張して1カードIDに複数の効果（activation/ignition）を登録できるようにする

## 背景と目的

現在の ChainableActionRegistry は `Map<number, ChainableAction>` で実装されており、1つのカードIDに対して1つの効果しか登録できない。しかし、遊戯王カードは1枚で複数の効果を持つことが多い：

- **発動時効果（activation）**: カードを手札/セット状態から発動する際の効果
- **起動効果（ignition）**: フィールド上のカードの効果をプレイヤーが任意に発動

例えば《チキンレース》は、発動時効果（カードの発動）と起動効果（1000LP払って1ドロー）の両方を持つ。現状では起動効果が ActivateIgnitionEffectCommand 内でハードコードされており、汎用化が必要。

### テスト対象カード

起動効果の汎用化を検証するため、以下の2枚のカードを対象とする：

1. **《チキンレース》(Chicken Game)** ID=67616300
   - 発動時効果: なし（フィールド魔法の配置のみ）
   - 起動効果: 1000LP払って1ドロー
   - 永続効果: ダメージ無効化（AdditionalRule で実装済み）

2. **《王立魔法図書館》(Royal Magical Library)** ID=70791313
   - 起動効果: 1ドロー（本Specでは簡略化実装）
   - 永続効果: 魔法発動時にカウンター追加（本Spec外）
   - 魔力カウンターシステム（本Spec外）

### 将来の拡張（本スコープ外）

以下の効果カテゴリは、レジストリの拡張性を考慮しつつ、今回は実装しない：

- **誘発効果（trigger）**: 特定のゲーム状態変化をトリガーに発動
- **誘発即時効果（quick）**: スペルスピード2でチェーンに割り込める効果

## User Scenarios & Testing _(mandatory)_

### User Story 1 - 起動効果の汎用発動 (Priority: P1)

ゲーム開発者として、フィールド上のカードの起動効果を汎用的に発動できるようにしたい。現状《チキンレース》のみハードコードされているが、他のカードの起動効果も同じ仕組みで発動できるべき。

**Why this priority**: 現在の課題（ハードコード問題）を直接解決し、新しいカード追加時の開発効率を大幅に向上させる。

**Independent Test**: 《王立魔法図書館》の起動効果を追加し、ActivateIgnitionEffectCommand で正常に発動できることを確認する。

**Acceptance Scenarios**:

1. **Given** フィールドに起動効果を持つカードが存在する, **When** プレイヤーがそのカードの起動効果を選択する, **Then** レジストリから該当する起動効果が取得され、発動処理が実行される
2. **Given** 1枚のカードに複数の起動効果が登録されている, **When** プレイヤーがそのカードを選択する, **Then** 発動可能な起動効果の一覧が取得できる
3. **Given** 起動効果が登録されていないカードがフィールドにある, **When** 起動効果を発動しようとする, **Then** 「起動効果がない」旨のエラーが返される

---

### User Story 2 - 発動時効果と起動効果の共存 (Priority: P1)

ゲーム開発者として、1つのカードに発動時効果と起動効果を両方登録できるようにしたい。《チキンレース》のように、カード発動時の効果と、フィールド設置後の起動効果が別々に存在するカードをサポートする必要がある。

**Why this priority**: 遊戯王カードの基本的な効果構造をサポートするために必須。P1と同等の重要度。

**Independent Test**: 《チキンレース》に発動時効果（ChickenGameActivation）と起動効果（ChickenGameIgnitionEffect）を両方登録し、それぞれが独立して動作することを確認する。

**Acceptance Scenarios**:

1. **Given** 同一カードIDに activation と ignition が両方登録されている, **When** カードを手札から発動する, **Then** activation の効果が実行される
2. **Given** 同一カードIDに activation と ignition が両方登録されている, **When** フィールドのカードの起動効果を発動する, **Then** ignition の効果が実行される

---

### User Story 3 - 王立魔法図書館の起動効果（簡略版） (Priority: P2)

ゲーム開発者として、《王立魔法図書館》の起動効果（1ドロー）を実装し、起動効果の汎用化が正しく動作することを検証したい。本Specでは魔力カウンターシステムを実装しないため、コスト条件なしの簡略版とする。

**Why this priority**: 起動効果の汎用化を2種類のカードで検証することで、設計の妥当性を確認できる。

**Independent Test**: 《王立魔法図書館》がモンスターゾーンに存在する状態で、起動効果を発動して1ドローできることを確認する。

**Acceptance Scenarios**:

1. **Given** 《王立魔法図書館》がモンスターゾーンに表側表示で存在する, **When** 起動効果を発動する, **Then** デッキから1枚ドローできる
2. **Given** 《王立魔法図書館》がモンスターゾーンに存在しない, **When** 起動効果を発動しようとする, **Then** 発動できない

---

### Edge Cases

- 同一カードに同じカテゴリの効果が複数登録されている場合、すべて取得できるか？
- 効果の発動条件（canActivate）が false を返す効果は、取得結果から除外されるべきか？
- レジストリの clear() 後に再初期化した場合、正しく動作するか？
- モンスターカードの起動効果と魔法カードの起動効果が同じ仕組みで動作するか？

## Requirements _(mandatory)_

### Functional Requirements

- **FR-001**: レジストリは1つのカードIDに対して、activation（発動時効果）を1つ登録できなければならない
- **FR-002**: レジストリは1つのカードIDに対して、ignition（起動効果）を複数登録できなければならない
- **FR-003**: レジストリは明示的なAPI（`getActivation(cardId)`, `getIgnitionEffects(cardId)` 等）を提供しなければならない
- **FR-004**: 既存の曖昧な `get(cardId)` メソッドは廃止し、呼び出し側を新APIに移行しなければならない
- **FR-005**: ChainableAction は自身の効果カテゴリ（effectCategory）を持たなければならない
- **FR-006**: ChainableAction は効果を一意に識別する effectId を持たなければならない（1ターンに1度制限等で使用）
- **FR-007**: 《王立魔法図書館》の起動効果（1ドロー、簡略版）がレジストリに登録され、発動可能でなければならない

### Out of Scope（将来の拡張）

以下は本スコープでは実装しないが、レジストリの設計は拡張可能であること：

- trigger（誘発効果）の登録・取得
- quick（誘発即時効果）の登録・取得
- ゲームイベントタイプからの誘発効果逆引き検索
- 強制発動/任意発動の区別
- 魔力カウンターシステム（カウンターの追加・消費・最大値管理）
- 《王立魔法図書館》の永続効果（魔法発動時にカウンターを置く）
- 《王立魔法図書館》の起動効果の正式なコスト条件（カウンター3つ消費）

### Key Entities

- **ChainableAction**: チェーンブロックを作る処理の基本モデル。effectCategory と effectId を新たに持つ
- **CardEffectEntry**: 1つのカードが持つ効果群を表現。activation（1つ）、ignition（複数）を含む
- **EffectCategory**: 効果カテゴリを表す型（"activation" | "ignition"）。将来的に "trigger" | "quick" を追加可能

## Success Criteria _(mandatory)_

### Measurable Outcomes

- **SC-001**: 《チキンレース》の発動時効果と起動効果が、同一カードIDで共存して正しく動作する
- **SC-002**: ActivateIgnitionEffectCommand から《チキンレース》固有のハードコードが除去され、任意の起動効果に対応できる
- **SC-003**: 新しいカードの起動効果を追加する際、レジストリへの登録のみで発動可能になる（Command の修正不要）
- **SC-004**: 既存の呼び出し側（ActivateSpellCommand 等）が新APIに移行され、全テストが通過する
- **SC-005**: 《王立魔法図書館》の起動効果（簡略版）が、レジストリ登録のみで ActivateIgnitionEffectCommand から発動できる

## Assumptions

- 1つのカードに登録できる activation は1つのみ（カードの発動は1回しかできないため）
- ignition は1つのカードに複数登録可能（効果①②③など）
- レジストリの内部構造は、将来 trigger/quick を追加できるよう拡張性を持たせる
- 効果の優先順位や発動順序は、このスコープでは扱わない（将来の拡張）
- 《王立魔法図書館》の起動効果は、本Specでは魔力カウンター条件なしの簡略版として実装する
- 《王立魔法図書館》のカードデータ（モンスターカード）は既存の仕組みで追加可能と仮定する
