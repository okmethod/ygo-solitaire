# Feature Specification: 魔力カウンターシステムと永続効果トリガー機構

**Feature Branch**: `017-magic-counter-system`
**Created**: 2026-02-01
**Status**: Draft
**Input**: 王立魔法図書館の永続効果（魔法カードが発動されるたび、魔力カウンターを置く）を実装する。永続効果（AdditionalRule）の方式設計と、魔力カウンターシステムの方式設計を含む。

## User Scenarios & Testing _(mandatory)_

### User Story 1 - 魔力カウンターの自動蓄積 (Priority: P1)

ユーザーがプレイ中、王立魔法図書館がフィールドに表側表示で存在する状態で魔法カードを発動すると、図書館に魔力カウンターが自動的に1つ置かれる。

**Why this priority**: 王立魔法図書館の核心機能。この永続効果がないと、カウンターを消費する起動効果（ドロー）も意味をなさない。

**Independent Test**: 王立魔法図書館をフィールドに配置し、任意の魔法カードを発動することで、カウンターが1つ増えることを確認できる。

**Acceptance Scenarios**:

1. **Given** 王立魔法図書館が自分フィールドに表側表示で存在し、魔力カウンターが0個の状態、**When** 通常魔法カードを発動する、**Then** 王立魔法図書館に魔力カウンターが1個置かれる
2. **Given** 王立魔法図書館が自分フィールドに表側表示で存在し、魔力カウンターが2個の状態、**When** 魔法カードを発動する、**Then** 魔力カウンターが3個になる（上限）
3. **Given** 王立魔法図書館が自分フィールドに表側表示で存在し、魔力カウンターが3個の状態、**When** 魔法カードを発動する、**Then** 魔力カウンターは3個のまま変化しない（上限超過しない）

---

### User Story 2 - 魔力カウンターのUI表示 (Priority: P1)

ユーザーがゲーム画面を見たとき、カードに置かれている魔力カウンターの数を視覚的に把握できる。

**Why this priority**: カウンターが溜まっているかどうかが分からないと、起動効果を発動できるタイミングを判断できない。

**Independent Test**: 魔力カウンターが1個以上あるカードをフィールドで表示し、カウンター数が見えることを確認できる。

**Acceptance Scenarios**:

1. **Given** 王立魔法図書館に魔力カウンターが2個置かれている状態、**When** フィールドを表示する、**Then** カード上または近辺に「2」というカウンター数が表示される
2. **Given** 王立魔法図書館に魔力カウンターが0個の状態、**When** フィールドを表示する、**Then** カウンター表示は非表示または「0」が表示される

---

### User Story 3 - 複数体の王立魔法図書館の独立管理 (Priority: P2)

ユーザーがフィールドに2体以上の王立魔法図書館を配置している場合、それぞれが独立してカウンターを蓄積する。

**Why this priority**: 同名カードが複数存在する場合の整合性は重要だが、通常のプレイでは1体のみ使用することが多い。

**Independent Test**: 2体の王立魔法図書館を配置し、魔法カードを発動した際に両方に1個ずつカウンターが置かれることを確認できる。

**Acceptance Scenarios**:

1. **Given** 2体の王立魔法図書館（A、B）が自分フィールドに表側表示で存在する、**When** 魔法カードを1枚発動する、**Then** AとBそれぞれに魔力カウンターが1個ずつ置かれる
2. **Given** 王立魔法図書館Aに2個、Bに1個のカウンターがある状態、**When** 魔法カードを1枚発動する、**Then** Aは3個（上限）、Bは2個になる

---

### User Story 4 - カウンター消費によるドロー効果 (Priority: P2)

ユーザーが王立魔法図書館の起動効果を発動し、魔力カウンターを3つ消費して1枚ドローできる。

**Why this priority**: カウンター蓄積（P1）と組み合わせて初めて完全な機能となる。既存の起動効果フレームワークを活用するため、実装コストは比較的低い。

**Independent Test**: 魔力カウンターが3個以上ある王立魔法図書館の起動効果を発動し、カウンターが3個減り、1枚ドローすることを確認できる。

**Acceptance Scenarios**:

1. **Given** 王立魔法図書館に魔力カウンターが3個置かれている、**When** 起動効果の発動を選択する、**Then** 発動可能として選択肢に表示される
2. **Given** 王立魔法図書館に魔力カウンターが2個置かれている、**When** 起動効果の発動を試みる、**Then** 発動条件を満たさないため選択肢に表示されない
3. **Given** 王立魔法図書館に魔力カウンターが3個置かれている、**When** 起動効果を発動する、**Then** カウンターが0個になり、デッキから1枚ドローする

---

### Edge Cases

- 王立魔法図書館が裏側表示の場合、魔法発動時にカウンターは置かれない
- フィールド魔法、速攻魔法、永続魔法など、すべての魔法タイプで発動時にカウンターが置かれる
- 王立魔法図書館自身が場を離れた場合、その図書館に置かれていたカウンターは消滅する（カードと共に消える）
- 魔法カードの発動が無効化された場合でも、「発動」自体は行われたためカウンターは置かれる（本アプリでは発動無効化は未実装のため、現時点では考慮不要）

## Requirements _(mandatory)_

### Functional Requirements

- **FR-001**: システムは、カードインスタンスごとに魔力カウンターの数を管理できなければならない
- **FR-002**: システムは、魔法カード発動時に、フィールド上の表側表示の対象カードに魔力カウンターを自動的に置かなければならない
- **FR-003**: 魔力カウンターの上限は、各カードの効果テキストで定義された値に従わなければならない（王立魔法図書館は最大3個）
- **FR-004**: システムは、起動効果発動時にカウンターを消費（取り除き）できなければならない
- **FR-005**: UIは、カードに置かれている魔力カウンターの数を表示しなければならない
- **FR-006**: 複数の同名カードがフィールドに存在する場合、各カードは独立してカウンターを管理しなければならない
- **FR-007**: 永続効果のトリガー機構として、「魔法カード発動」イベントを検知し、対応するAdditionalRuleを実行できなければならない

### Key Entities

- **CardInstance.counters**: カードインスタンスに紐づくカウンター情報。魔力カウンターを含む複数種類のカウンターを管理可能な構造。
- **TriggerEvent**: 永続効果が反応するイベントの種類（"spellActivated"など）
- **AdditionalRule（拡張）**: トリガーイベントと、トリガー発火時の処理（onTrigger）を持つ永続効果モデル

## Success Criteria _(mandatory)_

### Measurable Outcomes

- **SC-001**: 王立魔法図書館がフィールドに存在する状態で魔法カードを発動すると、100%の確率で魔力カウンターが正しく加算される
- **SC-002**: カウンター数がUIに正確に反映され、ユーザーが現在のカウンター数を1秒以内に視認できる
- **SC-003**: 複数の王立魔法図書館が存在する場合、各カードのカウンターが独立して管理され、相互に干渉しない
- **SC-004**: 魔力カウンターが3個以上ある場合にのみ起動効果が発動可能となり、発動後はカウンターが正確に3個減少する
- **SC-005**: 永続効果のトリガー機構が、既存のChainableAction（発動する効果）の実行フローを妨げない

## Assumptions

- 魔力カウンターの上限（最大3個）は王立魔法図書館固有の制限であり、魔力カウンター一般の制限ではない。将来的に他の魔力カウンターカードを実装する場合、カードごとに上限を設定できる設計とする。
- 永続効果の発生源（どのカードから発生した効果か）の追跡は、本機能ではTODOとし、必要最小限の実装に留める。
- 複数の永続効果が同時に発動する場合の厳密な順序制御は、本アプリの範囲では考慮しない。ただし、各カードが独立して整合性のある管理を行うことは保証する。
- 魔法カードの「発動」は、チェーンブロックを作る処理（ActivateSpellCommand等）が実行されたタイミングを指す。
