# Feature Specification: Card Effect Execution System

**Feature Branch**: `004-card-effect-execution`
**Created**: 2025-12-06
**Status**: Draft
**Input**: User description: "強欲な壺と天使の施しの効果処理を、Clean Architectureの3層（Domain/Application/Presentation）に適切に分離して実装する。強欲な壺は2枚ドロー、天使の施しは3枚ドロー後に手札から2枚選択して捨てる効果を実現する。"

## User Scenarios & Testing *(mandatory)*

### User Story 1 - Activate "Pot of Greed" (Priority: P1)

プレイヤーがメインフェイズ1で「強欲な壺」を手札から発動すると、デッキから2枚カードをドローできる。

**Why this priority**: カード効果実行システムの最もシンプルなユースケースであり、ユーザー入力を必要としない自動実行型効果の基盤となる。この機能が動作することで、効果処理の基本フローが検証できる。

**Independent Test**: シミュレーターで「強欲な壺」を手札に持ち、メインフェイズ1で発動すると、手札が2枚増えることを確認できる。発動前後のカード枚数をカウントすることで独立してテスト可能。

**Acceptance Scenarios**:

1. **Given** プレイヤーが手札に「強欲な壺」を持ち、メインフェイズ1にいる, **When** 「強欲な壺」をクリックして発動する, **Then** デッキから2枚ドローされ、手札が2枚増える
2. **Given** プレイヤーがデッキに1枚しかカードがない状態で「強欲な壺」を発動しようとする, **When** 発動を試みる, **Then** エラーメッセージが表示され、発動が失敗する
3. **Given** プレイヤーが「強欲な壺」を発動した, **When** 効果が解決される, **Then** 「強欲な壺」が墓地に送られる

---

### User Story 2 - Activate "Graceful Charity" (Priority: P2)

プレイヤーがメインフェイズ1で「天使の施し」を手札から発動すると、まず3枚ドローし、その後手札から2枚を選択して捨てることができる。

**Why this priority**: ユーザー入力を必要とする効果処理の実装であり、カード選択UIと効果解決フローの統合が必要。P1の基盤の上に構築される。

**Independent Test**: シミュレーターで「天使の施し」を発動し、(1) 3枚ドロー後に手札選択モーダルが表示される、(2) 2枚選択して確定すると墓地に送られる、という一連のフローを実行できることで独立してテスト可能。

**Acceptance Scenarios**:

1. **Given** プレイヤーが手札に「天使の施し」を持ち、メインフェイズ1にいる, **When** 「天使の施し」をクリックして発動する, **Then** デッキから3枚ドローされ、カード選択モーダルが表示される
2. **Given** カード選択モーダルが表示されている, **When** 手札から2枚のカードをクリックして選択する, **Then** 選択されたカードがハイライト表示され、「確定」ボタンが有効化される
3. **Given** 2枚のカードを選択済み, **When** 「確定」ボタンをクリックする, **Then** 選択された2枚のカードが墓地に送られ、モーダルが閉じる
4. **Given** カード選択モーダルで1枚しか選択していない, **When** 「確定」ボタンを見る, **Then** ボタンは無効化されており、クリックできない
5. **Given** プレイヤーがデッキに2枚しかカードがない状態で「天使の施し」を発動しようとする, **When** 発動を試みる, **Then** エラーメッセージが表示され、発動が失敗する

---

### User Story 3 - Effect Resolution Progress Display (Priority: P3)

効果解決中は、プレイヤーに現在の解決ステップが視覚的に表示される。

**Why this priority**: ユーザー体験の向上に寄与するが、コア機能ではない。効果が正しく動作していれば、進行状況表示がなくてもゲームプレイは可能。

**Independent Test**: 「天使の施し」を発動し、(1) 「3枚ドローします」というメッセージが表示される、(2) ドロー後に「手札から2枚選択してください」というメッセージが表示される、という表示切り替えを確認できる。

**Acceptance Scenarios**:

1. **Given** プレイヤーが「天使の施し」を発動した, **When** 効果解決が開始される, **Then** 「デッキから3枚ドローします」というメッセージがモーダルに表示される
2. **Given** 3枚ドロー後, **When** 次のステップに進む, **Then** 「手札から2枚選択して捨ててください」というメッセージに更新される
3. **Given** 効果解決中, **When** モーダルの外側をクリックする, **Then** モーダルは閉じられず、効果解決を続行する必要がある

---

### Edge Cases

- **デッキ枚数不足**: 「強欲な壺」を発動しようとしたが、デッキに2枚未満のカードしかない場合、発動が失敗し、エラーメッセージが表示される
- **手札選択のキャンセル**: 「天使の施し」の効果で3枚ドローした後、2枚選択する前にゲームを中断した場合、ゲーム状態は効果解決中のまま保持され、再開時に選択を続行できる
- **同時発動**: 複数の魔法カードを連続で発動した場合、各効果は順次解決され、前の効果が完全に解決されるまで次の発動は待機する
- **ゲーム終了後の発動**: ゲームオーバー後にカードを発動しようとした場合、発動が拒否される

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: システムは「強欲な壺」（カードID: 55144522）を発動したとき、デッキから2枚ドローする処理を実行しなければならない
- **FR-002**: システムは「天使の施し」（カードID: 79571449）を発動したとき、デッキから3枚ドローし、その後ユーザーに手札から2枚選択を促さなければならない
- **FR-003**: システムはカード発動時に、そのカードIDに基づいて適切な効果処理を判定し実行しなければならない
- **FR-004**: システムは効果解決中、ユーザーが必要な入力（カード選択など）を完了するまで、ゲーム進行を一時停止しなければならない
- **FR-005**: システムは手札からのカード選択UIを提供し、指定された枚数が選択されるまで確定ボタンを無効化しなければならない
- **FR-006**: システムは効果解決の各ステップ（ドロー、選択待ち、破棄など）の進行状況をユーザーに表示しなければならない
- **FR-007**: システムは効果実行前に実行可能性を検証し（デッキ枚数など）、実行不可能な場合はエラーを返さなければならない
- **FR-008**: システムは効果解決が完了したとき、発動したカードを墓地に送らなければならない
- **FR-009**: システムは複数枚のカードを破棄する処理を一度に実行できなければならない
- **FR-010**: システムはゲームオーバー後のカード発動を拒否しなければならない

### Key Entities

- **Card Effect**: カードIDと効果処理の対応関係を表す。各カードは固有の効果ロジック（ドロー枚数、選択枚数など）を持つ
- **Effect Resolution Step**: 効果解決の1ステップを表す。タイトル、メッセージ、実行するアクション、キャンセル可否を含む
- **Card Selection State**: カード選択UIの状態を表す。選択中のカードID配列、最大選択枚数、選択モードの有効/無効を含む
- **Game Command**: ゲーム状態を変更する操作を表す。DrawCardCommand（ドロー）、DiscardCardsCommand（破棄）、ActivateSpellCommand（発動）を含む

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: プレイヤーが「強欲な壺」を発動すると、デッキから2枚ドローされ、手札が2枚増える
- **SC-002**: プレイヤーが「天使の施し」を発動すると、3枚ドロー後に手札から2枚選択して捨てることができる
- **SC-003**: カード選択モーダルで、指定枚数（2枚）を選択するまで確定ボタンが無効化される
- **SC-004**: デッキ枚数不足などのエラーケースで、適切なエラーメッセージが表示され、ゲーム状態が壊れない
- **SC-005**: 効果解決中のユーザー操作（カード選択）を、初見のユーザーが直感的に完了できる
