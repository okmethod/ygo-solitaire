# Feature Specification: Card Pool Expansion - 6 New Spell Cards

**Feature Branch**: `011-card-pool-expansion`
**Created**: 2025-12-30
**Status**: Draft
**Input**: User description: "カードプールに6枚の新規通常魔法・速攻魔法を追加: 成金ゴブリン、一時休戦、打ち出の小槌、手札断札、闇の量産工場、テラフォーミング。現在の効果システム（ChainableAction）で対応可能か検証し、必要に応じて拡張する。"

## User Scenarios & Testing _(mandatory)_

### User Story 1 - Simple Draw Effects (Priority: P1)

プレイヤーは、既存の「強欲な壺」「天使の施し」と同様の、シンプルなドロー効果カードをデッキに組み込み、コンボの構築幅を広げたい。成金ゴブリン（1枚ドロー＋相手1000LP回復）と一時休戦（双方1枚ドロー＋ダメージ無効化）を追加する。

**Why this priority**: 既存のドローカード実装（PotOfGreedAction, GracefulCharityAction）と同じパターンで実装可能。現在の効果システム（ChainableAction）の検証MVPとして最適。

**Independent Test**: 成金ゴブリンを手札から発動し、1枚ドローでき、相手LPが1000回復することを確認。一時休戦を発動し、双方が1枚ドローし、ダメージ無効化フラグが立つことを確認。

**Acceptance Scenarios**:

1. **Given** メインフェーズで成金ゴブリンが手札にある、**When** 成金ゴブリンを発動、**Then** デッキから1枚ドローし、相手のLPが1000回復する
2. **Given** メインフェーズで一時休戦が手札にある、**When** 一時休戦を発動、**Then** 自分と相手が1枚ずつドローし、ダメージ無効化効果が適用される

---

### User Story 2 - Hand Management Effects (Priority: P2)

プレイヤーは、手札を調整するカード（打ち出の小槌、手札断札）を使用して、より柔軟なコンボ構築を行いたい。打ち出の小槌（任意枚数デッキ戻し→同数ドロー）と手札断札（双方2枚捨て→2枚ドロー）を追加する。

**Why this priority**: カード選択UI（CardSelectionModal）を活用し、既存のGracefulCharityAction（カード選択→捨てる）の応用パターンを検証。速攻魔法のspellSpeed=2も検証可能。

**Independent Test**: 打ち出の小槌で手札から2枚選択してデッキに戻し、2枚ドローできることを確認。手札断札を発動し、双方が2枚捨てて2枚ドローできることを確認。

**Acceptance Scenarios**:

1. **Given** メインフェーズで打ち出の小槌が手札にあり、手札が3枚以上、**When** 打ち出の小槌を発動し2枚選択、**Then** 選択した2枚がデッキに戻り、デッキがシャッフルされ、2枚ドローする
2. **Given** メインフェーズで手札断札が手札にあり、手札が3枚以上、**When** 手札断札を発動、**Then** 自分と相手が2枚ずつ捨て、2枚ずつドローする

---

### User Story 3 - Graveyard Recovery Effects (Priority: P3)

プレイヤーは、墓地からカードを回収するカード（闇の量産工場）と、デッキからフィールド魔法をサーチするカード（テラフォーミング）を使用したい。

**Why this priority**: 墓地からの回収は既存実装にない新パターン。フィールド魔法サーチも新カテゴリ。効果システムの拡張性を検証。

**Independent Test**: 闇の量産工場で墓地の通常モンスター2体を選択し、手札に加えることを確認。テラフォーミングでデッキからフィールド魔法1枚を手札に加えることを確認。

**Acceptance Scenarios**:

1. **Given** メインフェーズで闇の量産工場が手札にあり、墓地に通常モンスターが2体以上、**When** 闇の量産工場を発動し2体選択、**Then** 選択したモンスターが墓地から手札に移動する
2. **Given** メインフェーズでテラフォーミングが手札にあり、デッキにフィールド魔法が1枚以上、**When** テラフォーミングを発動、**Then** デッキからフィールド魔法1枚を選択し、手札に加える

---

### Edge Cases

- 打ち出の小槌で0枚選択した場合、何も起こらない（デッキ戻しもドローもなし）
- 打ち出の小槌で手札の全カードを戻した場合でも、正常にドローできる
- 手札断札で手札が2枚未満の場合、発動できない
- 闇の量産工場で墓地に通常モンスターが2体未満の場合、発動できない
- テラフォーミングでデッキにフィールド魔法が存在しない場合、発動できない
- 一時休戦のダメージ無効化効果は、次の相手ターン終了時まで持続する（スコープ外：現在は相手ターンが存在しないため、永続効果として実装）

## Requirements _(mandatory)_

### Functional Requirements

- **FR-001**: システムは成金ゴブリン（ID=70368879）を通常魔法として実装し、発動時にデッキから1枚ドロー＋相手LP1000回復の効果を実行できなければならない
- **FR-002**: システムは一時休戦（ID=33782437）を通常魔法として実装し、発動時に双方1枚ドロー＋ダメージ無効化効果を適用できなければならない
- **FR-003**: システムは打ち出の小槌（ID=85852291）を通常魔法として実装し、手札から任意枚数（0枚以上）選択→デッキ戻し→シャッフル→同数ドローを実行できなければならない
- **FR-004**: システムは手札断札（ID=74519184）を速攻魔法として実装し、発動時に双方が手札2枚を捨て→2枚ドローを実行できなければならない
- **FR-005**: システムは闇の量産工場（ID=90928333）を通常魔法として実装し、墓地の通常モンスター2体を選択→手札に加える効果を実行できなければならない
- **FR-006**: システムはテラフォーミング（ID=73628505）を通常魔法として実装し、デッキからフィールド魔法1枚を選択→手札に加える効果を実行できなければならない
- **FR-007**: すべてのカードはChainableActionモデルに準拠し、canActivate/createActivationSteps/createResolutionStepsを実装しなければならない
- **FR-008**: カード選択が必要な効果（打ち出の小槌、手札断札、闇の量産工場、テラフォーミング）は、CardSelectionModalを使用してユーザー入力を受け付けなければならない
- **FR-009**: 新規追加カードはすべてChainableActionRegistryに登録され、ActivateSpellCommandから呼び出し可能でなければならない
- **FR-010**: 速攻魔法（手札断札）はspellSpeed=2を持ち、将来のチェーンシステム実装に備えなければならない

### Key Entities

- **UpstartGoblin (成金ゴブリン)**: 通常魔法、1枚ドロー＋相手1000LP回復
- **CeasefireVariant (一時休戦)**: 通常魔法、双方1枚ドロー＋ダメージ無効化
- **ReloadCard (打ち出の小槌)**: 通常魔法、任意枚数手札戻し→同数ドロー
- **CardDestruction (手札断札)**: 速攻魔法、双方2枚捨て→2枚ドロー
- **DarkFactory (闇の量産工場)**: 通常魔法、墓地の通常モンスター2体を手札に加える
- **Terraforming (テラフォーミング)**: 通常魔法、デッキからフィールド魔法1枚をサーチ

## Success Criteria _(mandatory)_

### Measurable Outcomes

- **SC-001**: 6枚すべてのカードが正常に発動でき、効果が正しく適用されること（単体テストで検証）
- **SC-002**: カード選択が必要な効果（打ち出の小槌、闇の量産工場、テラフォーミング）で、CardSelectionModalが正しく開き、選択したカードが効果に反映されること（E2Eテストで検証）
- **SC-003**: 既存のカード（強欲な壺、天使の施し）と同様に、NotificationLevelシステム（silent/info/interactive）が正しく機能すること
- **SC-004**: 速攻魔法（手札断札）がspellSpeed=2を持ち、将来のチェーンシステムに対応可能であること（型定義で検証）
- **SC-005**: すべてのカードがChainableActionパターンに適合し、コード重複なく実装されること（レビューで検証）
- **SC-006**: エッジケース（手札不足、墓地不足、デッキ不足）で適切にエラーハンドリングされること（単体テストで検証）

## Assumptions

- 現在のゲームは1ターンキル（先行1ターン目のみ）のため、相手ターンは存在しない。一時休戦のダメージ無効化効果は永続効果として実装する。
- 相手プレイヤーの手札・LP・墓地は現在スコープ外のため、相手側の効果（LP回復、手札2枚捨て等）は内部状態のみ反映し、UI表示は行わない。
- フィールド魔法は現在未実装だが、テラフォーミングのサーチ対象として将来的に追加される前提で実装する。
- デッキのシャッフル機能は既存実装（shuffleDeck関数）を使用する。
- 通常モンスターの判定は、CardDataのtype="Normal Monster"で行う。

## Scope Exclusions

- チェーンシステムの実装（spellSpeed定義のみ行い、チェーン処理は将来実装）
- 相手ターンの実装（一時休戦のダメージ無効化は永続効果として簡易実装）
- 相手プレイヤーのUI表示（手札、LP、墓地の視覚的表現は行わない）
- フィールド魔法カードの実装（テラフォーミングのサーチ対象として定義のみ）
- ダメージ計算システムの実装（一時休戦のダメージ無効化効果は将来実装時に対応）

## Dependencies

- 既存のChainableActionシステム（PotOfGreedAction, GracefulCharityAction）
- CardSelectionModal（カード選択UI）
- NotificationLevelシステム（silent/info/interactive）
- shuffleDeck関数（デッキシャッフル機能）
- CardDataRegistry（カードタイプ判定: Normal Monster, Field Spell等）
