# Feature Specification: UX改善（自動フェーズ進行・デッキシャッフル・自動勝利判定）

**Feature Branch**: `006-ux-automation`
**Created**: 2024-12-20
**Status**: Draft
**Input**: User description: "「強欲なエクゾディア」デッキのUX改善として、(1)ゲーム開始時に自動でMain Phaseまで進行、(2)デッキシャッフル機能追加、(3)自動勝利判定、(4)不要なUIボタン削除を実装する"

## User Scenarios & Testing *(mandatory)*

### User Story 1 - ゲーム開始時の自動フェーズ進行 (Priority: P1)

プレイヤーがゲームを開始すると、先行1ターン目のDrawフェーズ・Standbyフェーズを自動でスキップし、Main Phaseまで自動的に進行する。各フェーズ移行時にはトースト通知で現在のフェーズを表示する。

**Why this priority**: 先行1ターン目ではDrawフェーズでカードをドローせず、Standbyフェーズでも何もアクションがないため、手動でフェーズを進めるのは時間の無駄。この自動化により、プレイヤーは即座にメインフェーズでカードをプレイできる。最も体感的なUX改善効果が高い。

**Independent Test**: ゲーム開始時に自動的にMain Phaseまで進行し、トースト通知が表示されることを確認することで、独立してテスト可能。

**Acceptance Scenarios**:

1. **Given** プレイヤーがシミュレータページにアクセスした状態、**When** ゲームが開始される、**Then** 自動的にDrawフェーズ→Standbyフェーズ→Main Phaseと進行し、各フェーズ移行時にトースト通知が表示される
2. **Given** Main Phaseに到達した状態、**When** プレイヤーがカードをプレイできる、**Then** 手札からカードを発動できる

---

### User Story 2 - デッキシャッフル機能 (Priority: P2)

ゲーム開始時にデッキをシャッフルし、カードの順番をランダム化する。これにより、毎回異なる手札・ドロー順でゲームをプレイできる。

**Why this priority**: 現状ではカードの順番が固定されており、毎回同じゲーム展開になってしまう。シャッフル機能により、リプレイ性が向上し、異なるコンボや戦略を試せる。P1より優先度が低いのは、「同じ順番でも1回はプレイできる」ため。

**Independent Test**: ゲーム開始時にデッキがシャッフルされ、毎回異なる手札が配られることを確認することで、独立してテスト可能。

**Acceptance Scenarios**:

1. **Given** プレイヤーがシミュレータページにアクセスした状態、**When** ゲームが開始される、**Then** デッキがランダムにシャッフルされる
2. **Given** ゲームが複数回リロードされた状態、**When** 各ゲーム開始時の手札を比較する、**Then** 手札のカード順序が異なることを確認できる

---

### User Story 3 - 自動勝利判定 (Priority: P1)

カード効果解決後およびフェーズ移行後に、自動的に勝利条件をチェックする。Exodia5体揃いや、ライフポイント0などの勝利条件を満たした場合、即座にゲームオーバー画面を表示する。

**Why this priority**: 現状では勝利判定を手動で「Check Victory」ボタンをクリックする必要があり、勝利した瞬間を見逃したり、判定を忘れたりする可能性がある。自動判定により、ゲームの流れが自然になり、勝利の達成感が即座に得られる。P1相当の重要度。

**Independent Test**: Exodia5体が揃った瞬間に自動的に勝利画面が表示されることを確認することで、独立してテスト可能。

**Acceptance Scenarios**:

1. **Given** Exodiaパーツが4体手札にある状態、**When** 5体目のExodiaパーツをドローする、**Then** 自動的に勝利判定が実行され、勝利画面が表示される
2. **Given** カード効果（強欲な壺など）でドローした状態、**When** 効果解決が完了する、**Then** 自動的に勝利判定が実行される
3. **Given** フェーズが進行した状態、**When** 新しいフェーズに移行する、**Then** 自動的に勝利判定が実行される

---

### User Story 4 - 不要なUIボタン削除 (Priority: P3)

自動フェーズ進行・自動勝利判定の実装後、手動操作用の「Draw Card」「Advance Phase」「Check Victory」ボタンをUI上から削除する。デバッグ用途で残す場合は、Debug Infoセクション内に移動する。

**Why this priority**: これらのボタンは自動化により不要になるため、UI上に残しておくと混乱を招く。ただし、UI整理はコア機能ではないため、P3とする。デバッグ用に残す判断も可能。

**Independent Test**: UIを確認し、これらのボタンが削除されていること（またはDebugセクション内に移動していること）を確認することで、独立してテスト可能。

**Acceptance Scenarios**:

1. **Given** 自動化機能が実装された状態、**When** シミュレータページを表示する、**Then** 「Draw Card」「Advance Phase」「Check Victory」ボタンがUI上から削除されている（またはDebug Infoセクション内にのみ表示される）

---

### Edge Cases

- **ゲームロード中のフェーズ進行**: ゲームロード中（カードデータ取得中）にフェーズ自動進行が実行されると、不整合が発生する可能性がある。ロード完了後に自動進行を開始する必要がある。
- **複数回の勝利判定**: カード効果チェーン中に複数回勝利判定が呼ばれた場合、重複チェックを避ける必要がある（既に勝利判定済みの場合はスキップ）。
- **シャッフルの偏り**: 完全にランダムなシャッフルでも、稀に元の順番と同じになる可能性がある。これは正常動作として許容する。
- **フェーズ進行中のユーザー操作**: 自動フェーズ進行中にユーザーが何らかの操作をした場合、競合しないようにする必要がある。

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: システムは、ゲーム開始時（ターン1のDrawフェーズ開始時）に自動的にMain Phaseまでフェーズを進行しなければならない
- **FR-002**: システムは、各フェーズ移行時にトースト通知で「[フェーズ名]に移行しました」と表示しなければならない
- **FR-003**: システムは、ゲーム開始時にデッキをランダムにシャッフルしなければならない（Fisher-Yates等の標準的なシャッフルアルゴリズム使用）
- **FR-004**: システムは、カード効果解決後に自動的に勝利条件をチェックしなければならない
- **FR-005**: システムは、フェーズ移行後に自動的に勝利条件をチェックしなければならない
- **FR-006**: システムは、勝利条件を満たした場合、即座にゲームオーバー状態に遷移し、勝利画面を表示しなければならない
- **FR-007**: システムは、既に勝利判定済みの場合、重複して勝利判定を実行してはならない
- **FR-008**: システムは、自動化機能実装後、「Draw Card」「Advance Phase」「Check Victory」ボタンをUI上から削除しなければならない（またはDebug Infoセクション内にのみ表示する）
- **FR-009**: システムは、ゲームデータ（カード情報等）のロードが完了するまで、自動フェーズ進行を開始してはならない

### Key Entities

- **GameState**: ゲーム状態を保持するエンティティ。現在のフェーズ、ターン数、勝利判定フラグ等を含む
- **DeckZone**: デッキゾーンを表すエンティティ。シャッフル機能の対象となるカードインスタンスの配列を保持する
- **PhaseTransition**: フェーズ遷移を管理するエンティティ。自動進行ロジックと手動進行ロジックの両方を含む

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: プレイヤーがゲーム開始後、手動操作なしで2秒以内にMain Phaseに到達できる
- **SC-002**: デッキシャッフル機能により、10回のゲームリロードで10回とも異なる手札順序が得られる（統計的にランダム性を確認）
- **SC-003**: Exodia5体揃いの条件を満たした瞬間に、自動的に勝利画面が表示される（手動チェック不要）
- **SC-004**: 自動化機能実装後、「Draw Card」「Advance Phase」「Check Victory」ボタンがUI上に存在しない（またはDebugセクションのみ）
- **SC-005**: 全312テスト（既存のユニットテスト）が引き続きpassする
- **SC-006**: E2Eテストで、ゲーム開始→自動フェーズ進行→カード発動→自動勝利判定の一連のフローが正常に動作することを確認できる
